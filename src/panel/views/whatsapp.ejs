<%- include('partials/header') %>

<div class="container-fluid p-0">
    <div class="wa-app">
        
        <div class="wa-left-panel">
            <div class="wa-header">
                <div class="d-flex align-items-center">
                    <img src="https://ui-avatars.com/api/?name=Admin&background=00a884&color=fff" class="wa-avatar" style="width: 40px; height: 40px;">
                    <span class="fw-bold ms-2 text-dark">Sohbetler</span>
                </div>
                <div>
                    <i class="bi bi-chat-left-text-fill fs-5 wa-icon-btn"></i>
                    <i class="bi bi-three-dots-vertical fs-5 wa-icon-btn"></i>
                </div>
            </div>
            <div class="wa-search-box">
                <div class="position-relative">
                    <input type="text" class="wa-search-input" placeholder="Aratın veya yeni sohbet başlatın" id="searchInput">
                    <i class="bi bi-search position-absolute text-secondary" style="left: 12px; top: 8px; font-size: 13px;"></i>
                </div>
            </div>
            <div style="flex:1; overflow-y:auto;" id="chatList">
                <% chats.forEach(chat => { %>
                <div class="wa-chat-item" onclick="loadChat('<%= chat.chat_id %>', '<%= chat.client_id %>', '<%= chat.full_name %>', '<%= chat.profile_photo_url || '' %>')">
                    
                    <img src="<%= chat.profile_photo_url || 'https://ui-avatars.com/api/?name=' + chat.full_name %>" 
                         class="wa-avatar"
                         onerror="this.src='https://ui-avatars.com/api/?name=<%= chat.full_name %>&background=random'">
                    
                    <div style="flex:1; overflow:hidden;">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="fw-normal text-dark text-truncate" style="font-size: 16px;"><%= chat.full_name %></span>
                            <small class="text-secondary" style="font-size: 12px;"><%= chat.last_message_at ? new Date(chat.last_message_at).toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'}) : '' %></small>
                        </div>
                        <div class="d-flex justify-content-between mt-1 align-items-center">
                            <small class="text-secondary text-truncate" style="max-width: 200px; font-size: 13px;">Sohbeti görüntülemek için tıklayın</small>
                            <% if(chat.msg_count > 0) { %>
                                <span class="badge rounded-pill bg-success fw-normal" style="font-size: 11px;"><%= chat.msg_count %></span>
                            <% } %>
                        </div>
                    </div>
                </div>
                <% }) %>
            </div>
        </div>

        <div class="wa-main-panel">
            <div id="emptyState" class="wa-empty-state">
                <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" width="80" style="opacity: 0.2; margin-bottom: 20px;">
                <h2 class="fw-light mb-2">WhatsApp Web Paneli</h2>
                <p class="small">Mesajları okumak ve yanıtlamak için soldan bir sohbet seçin.</p>
                <p class="small mt-4 text-muted"><i class="bi bi-lock-fill"></i> Uçtan uca şifreli (Emülasyon)</p>
            </div>

            <div id="chatInterface" style="display: none; flex-direction: column; height: 100%;">
                <div class="wa-header" style="cursor: pointer;" onclick="toggleRightPanel()">
                    <div class="d-flex align-items-center">
                        <img id="headerAvatar" src="" class="wa-avatar" style="width: 40px; height: 40px;">
                        <div class="d-flex flex-column ms-2">
                            <span class="fw-bold text-dark" id="headerName" style="font-size: 16px;">İsim</span>
                            <small class="text-secondary" style="font-size: 13px;">Kişi bilgisi için tıklayın</small>
                        </div>
                    </div>
                    <div>
                        <i class="bi bi-search fs-5 wa-icon-btn me-2"></i>
                        <i class="bi bi-three-dots-vertical fs-5 wa-icon-btn"></i>
                    </div>
                </div>

                <div class="wa-msg-area" id="messagesArea"></div>

                <div class="wa-footer">
                    <i class="bi bi-emoji-smile fs-4 wa-icon-btn"></i>
                    <i class="bi bi-paperclip fs-4 wa-icon-btn ms-2 me-2"></i>
                    <input type="text" class="wa-input" id="messageInput" placeholder="Bir mesaj yazın" onkeypress="handleEnter(event)">
                    <i class="bi bi-mic fs-4 wa-icon-btn ms-2" id="btnMic"></i>
                    <i class="bi bi-send-fill fs-4 text-primary wa-icon-btn ms-2" style="display:none;" id="btnSend" onclick="sendMessage()"></i>
                </div>
            </div>
        </div>

        <div class="wa-right-panel" id="rightPanel">
            <div class="wa-header ps-3">
                <div class="d-flex align-items-center">
                    <i class="bi bi-x-lg wa-icon-btn me-3" onclick="toggleRightPanel()"></i>
                    <span class="fw-normal text-dark" style="font-size: 16px;">Kişi Bilgisi</span>
                </div>
            </div>
            
            <div style="flex: 1; overflow-y: auto;">
                <div class="text-center bg-white pb-4 pt-4 mb-2 shadow-sm">
                    <img id="cardAvatar" src="" class="wa-avatar-lg shadow-sm">
                    <h2 class="fw-normal mb-1 mt-3" id="cardName" style="font-size: 22px;">İsim</h2>
                    <p class="text-secondary mb-0" id="cardPhone" style="font-size: 16px;">+90 5XX XXX XX XX</p>
                </div>

                <div class="wa-info-section wa-btn-group">
                    <button class="wa-action-btn" id="btnTakeover" onclick="toggleTakeover()">
                        <div class="rounded-circle bg-light p-2 mb-1"><i class="bi bi-headset fs-5"></i></div>
                        <span>Bota Devret</span>
                    </button>
                    <button class="wa-action-btn danger" id="btnBlock" onclick="toggleBlock()">
                        <div class="rounded-circle bg-light p-2 mb-1"><i class="bi bi-slash-circle fs-5"></i></div>
                        <span>Engelle</span>
                    </button>
                    <button class="wa-action-btn" onclick="analyzeUser()">
                        <div class="rounded-circle bg-light p-2 mb-1"><i class="bi bi-stars fs-5 text-warning"></i></div>
                        <span>AI Analiz</span>
                    </button>
                </div>

                <div class="wa-info-section">
                    <div class="wa-info-label">Kişinin Sorunu / Derdi</div>
                    <div class="wa-info-value problem" id="cardSubject">Henüz belirtilmemiş</div>
                </div>

                <div class="wa-info-section">
                    <div class="wa-info-label">Şehir</div>
                    <div class="wa-info-value" id="cardCity">-</div>
                </div>

                <div class="wa-info-section">
                    <div class="wa-info-label">Meslek</div>
                    <div class="wa-info-value" id="cardJob">-</div>
                </div>

                <div class="wa-info-section">
                    <div class="wa-info-label">Yaş / Doğum Tarihi</div>
                    <div class="wa-info-value" id="cardBirth">-</div>
                </div>

                <div class="wa-info-section">
                    <div class="wa-info-label">Anne Adı</div>
                    <div class="wa-info-value" id="cardMother">-</div>
                </div>

                <div class="wa-info-section" id="aiAnalysisSection" style="display:none; border-left: 4px solid #ffc107;">
                    <div class="wa-info-label text-warning d-flex align-items-center">
                        <i class="bi bi-stars me-2"></i> Yapay Zeka Karakter Analizi
                    </div>
                    <div class="wa-info-value small mt-2" id="cardAnalysis" style="line-height: 1.5; font-style: italic;">...</div>
                </div>
            </div>
        </div>

    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    let currentChatId = null;
    let currentClientId = null;
    let currentProfile = null;

    function toggleRightPanel() {
        document.getElementById('rightPanel').classList.toggle('open');
    }

    document.getElementById('messageInput').addEventListener('input', function() {
        const hasText = this.value.trim().length > 0;
        document.getElementById('btnMic').style.display = hasText ? 'none' : 'block';
        document.getElementById('btnSend').style.display = hasText ? 'block' : 'none';
    });

    // Chat Yükle (Artık profileUrl'yi de alıyor)
    async function loadChat(chatId, clientId, fullName, profileUrl) {
        currentChatId = chatId;
        currentClientId = clientId;

        // UI Güncelle
        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('chatInterface').style.display = 'flex';
        document.getElementById('rightPanel').classList.add('open');

        // Avatar Belirleme Mantığı
        const avatarSrc = profileUrl && profileUrl !== 'null' ? profileUrl : `https://ui-avatars.com/api/?name=${fullName}&background=random`;

        // Header Bilgileri
        document.getElementById('headerName').innerText = fullName;
        document.getElementById('headerAvatar').src = avatarSrc;
        
        // Hata durumunda fallback (Header için)
        document.getElementById('headerAvatar').onerror = function() {
            this.src = `https://ui-avatars.com/api/?name=${fullName}&background=random`;
        };

        // Kart Bilgileri (Varsayılan)
        document.getElementById('cardAvatar').src = avatarSrc;
        document.getElementById('cardAvatar').onerror = function() {
            this.src = `https://ui-avatars.com/api/?name=${fullName}&background=random`;
        };

        // Mesajları Çek
        const msgArea = document.getElementById('messagesArea');
        msgArea.innerHTML = '<div class="text-center mt-5"><div class="spinner-border text-success"></div></div>';
        
        try {
            const msgRes = await fetch(`/api/chat/${chatId}/messages`);
            const msgData = await msgRes.json();
            if(msgData.success) renderMessages(msgData.messages);

            // Profil Detaylarını Çek
            const profRes = await fetch(`/api/chat/${chatId}/profile`);
            const profData = await profRes.json();
            if(profData.success) {
                currentProfile = profData.profile;
                updateProfileCard(currentProfile);
            }
        } catch(e) { console.error(e); }
        
        document.querySelectorAll('.wa-chat-item').forEach(el => el.classList.remove('active'));
        event.currentTarget.classList.add('active');
    }

    // Profil Kartını Doldur
    function updateProfileCard(p) {
        document.getElementById('cardName').innerText = p.full_name || 'İsimsiz';
        document.getElementById('cardPhone').innerText = p.phone || p.chat_id;
        document.getElementById('cardCity').innerText = p.city || '-';
        document.getElementById('cardJob').innerText = p.job || '-';
        document.getElementById('cardBirth').innerText = p.birth_date || '-';
        document.getElementById('cardMother').innerText = p.mother_name || '-';
        document.getElementById('cardSubject').innerText = p.subject || 'Henüz belirtilmemiş';

        // Eğer API'den gelen veride taze bir fotoğraf varsa onu da güncelle
        if (p.profile_photo_url && p.profile_photo_url !== 'null') {
             document.getElementById('cardAvatar').src = p.profile_photo_url;
             document.getElementById('headerAvatar').src = p.profile_photo_url;
        }

        // Buton Durumları
        const btnBlock = document.getElementById('btnBlock');
        const iconBlock = btnBlock.querySelector('i');
        if(p.is_blocked) {
            btnBlock.classList.add('active');
            btnBlock.querySelector('span').innerText = 'Engeli Kaldır';
            iconBlock.className = 'bi bi-check-circle fs-5';
        } else {
            btnBlock.classList.remove('active');
            btnBlock.querySelector('span').innerText = 'Engelle';
            iconBlock.className = 'bi bi-slash-circle fs-5';
        }

        const btnTakeover = document.getElementById('btnTakeover');
        const iconTakeover = btnTakeover.querySelector('i');
        if(p.status === 'waiting' || p.status === 'admin') {
             btnTakeover.querySelector('span').innerText = 'Bota Devret';
             btnTakeover.classList.add('active');
             iconTakeover.className = 'bi bi-robot fs-5';
        } else {
             btnTakeover.querySelector('span').innerText = 'Devral (Manuel)';
             btnTakeover.classList.remove('active');
             iconTakeover.className = 'bi bi-headset fs-5';
        }

        if(p.ai_analysis) {
            document.getElementById('aiAnalysisSection').style.display = 'block';
            document.getElementById('cardAnalysis').innerText = p.ai_analysis;
        } else {
            document.getElementById('aiAnalysisSection').style.display = 'none';
        }
    }

    function renderMessages(messages) {
        const area = document.getElementById('messagesArea');
        area.innerHTML = '';

        let lastDate = '';

        // Mesajlar zaten eski→yeni sıralı geliyor (db.getChatMessages'da reverse edildi)
        messages.forEach(msg => {
            const date = new Date(msg.created_at);
            const dateStr = date.toLocaleDateString('tr-TR');
            const timeStr = date.toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'});
            const isMe = msg.direction === 'outgoing';

            if(dateStr !== lastDate) {
                area.innerHTML += `
                    <div class="text-center my-3">
                        <span class="badge bg-white text-secondary fw-normal shadow-sm py-1 px-2 small text-uppercase" style="opacity:0.9">${dateStr}</span>
                    </div>`;
                lastDate = dateStr;
            }

            area.innerHTML += `
                <div class="wa-msg ${isMe ? 'outgoing' : 'incoming'}">
                    <div>${msg.content}</div>
                    <div class="wa-msg-meta">
                        ${timeStr} ${isMe ? '<i class="bi bi-check2-all ms-1 text-primary"></i>' : ''}
                    </div>
                </div>
            `;
        });
        area.scrollTop = area.scrollHeight;
    }

    async function analyzeUser() {
        if(!currentChatId) return;
        const btn = event.currentTarget;
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<div class="spinner-border spinner-border-sm"></div>';
        
        try {
            const res = await fetch(`/api/chat/${currentChatId}/analyze`, { method: 'POST' });
            const data = await res.json();
            if(data.success) {
                document.getElementById('aiAnalysisSection').style.display = 'block';
                document.getElementById('cardAnalysis').innerText = data.analysis;
            } else {
                alert("Hata: " + data.error);
            }
        } catch(e) { alert("Analiz yapılamadı"); }
        
        btn.innerHTML = originalHtml;
    }

    async function toggleBlock() {
        if(!currentProfile) return;
        const newState = !currentProfile.is_blocked;
        if(confirm(newState ? "Kişiyi engellemek istiyor musunuz?" : "Engeli kaldırmak istiyor musunuz?")) {
            await fetch(`/api/chat/${currentChatId}/block`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ blocked: newState })
            });
            currentProfile.is_blocked = newState;
            updateProfileCard(currentProfile);
        }
    }

    async function toggleTakeover() {
        if(!currentProfile) return;
        const isBotActive = !(currentProfile.status === 'waiting' || currentProfile.status === 'admin');
        
        if(isBotActive) {
            await fetch(`/api/chat/${currentChatId}/takeover`, { method: 'POST' });
            currentProfile.status = 'admin';
        } else {
            await fetch(`/api/chat/${currentChatId}/release`, { method: 'POST' });
            currentProfile.status = 'collecting';
        }
        updateProfileCard(currentProfile);
    }

    async function sendMessage() {
        const input = document.getElementById('messageInput');
        const text = input.value.trim();
        if(!text) return;
        
        const area = document.getElementById('messagesArea');
        const time = new Date().toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'});
        area.innerHTML += `
            <div class="wa-msg outgoing">
                <div>${text}</div>
                <div class="wa-msg-meta">${time} <i class="bi bi-clock ms-1"></i></div>
            </div>
        `;
        area.scrollTop = area.scrollHeight;
        input.value = '';
        document.getElementById('btnMic').style.display = 'block';
        document.getElementById('btnSend').style.display = 'none';

        await fetch('/api/send', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ clientId: currentClientId, chatId: currentChatId, message: text })
        });
    }

    function handleEnter(e) { if(e.key === 'Enter') sendMessage(); }
    
    document.getElementById('searchInput').addEventListener('keyup', function() {
        const val = this.value.toLowerCase();
        document.querySelectorAll('.wa-chat-item').forEach(el => {
            el.style.display = el.innerText.toLowerCase().includes(val) ? 'flex' : 'none';
        });
    });

    socket.on('newMessage', (data) => {
        if(currentChatId === data.chatId) {
            const area = document.getElementById('messagesArea');
            const isMe = data.direction === 'outgoing';
            const time = new Date(data.timestamp).toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'});
            area.innerHTML += `
                <div class="wa-msg ${isMe ? 'outgoing' : 'incoming'}">
                    <div>${data.body}</div>
                    <div class="wa-msg-meta">${time}</div>
                </div>
            `;
            area.scrollTop = area.scrollHeight;
        }
    });
</script>

<%- include('partials/footer') %>