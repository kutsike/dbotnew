<%- include('partials/header', { title, page }) %>

<style>
  :root {
    --profile-primary: #00a884;
    --profile-danger: #ea4c62;
    --profile-bg: #f0f2f5;
    --profile-card-bg: #ffffff;
    --profile-text: #000000;
    --profile-text-muted: #333333;
    --profile-border: #e9edef;
  }

  .profiles-container {
    display: flex;
    height: calc(100vh - 120px);
    background: var(--profile-bg);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  }

  /* Sol Panel - Profil Listesi */
  .profiles-list-panel {
    width: 380px;
    min-width: 320px;
    background: var(--profile-card-bg);
    border-right: 1px solid var(--profile-border);
    display: flex;
    flex-direction: column;
  }

  .profiles-header {
    padding: 16px 20px;
    background: var(--profile-card-bg);
    border-bottom: 1px solid var(--profile-border);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .profiles-header h5 {
    margin: 0;
    font-weight: 600;
    color: var(--profile-text);
  }

  .profiles-tabs {
    display: flex;
    padding: 12px 16px;
    gap: 8px;
    background: var(--profile-card-bg);
    border-bottom: 1px solid var(--profile-border);
  }

  .tab-btn {
    flex: 1;
    padding: 8px 12px;
    border: none;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    background: transparent;
    color: var(--profile-text-muted);
  }

  .tab-btn.active {
    background: var(--profile-primary);
    color: white;
  }

  .tab-btn:hover:not(.active) {
    background: var(--profile-bg);
  }

  .profiles-search {
    padding: 12px 16px;
    border-bottom: 1px solid var(--profile-border);
  }

  .profiles-search input {
    width: 100%;
    padding: 10px 14px;
    border: none;
    border-radius: 8px;
    background: var(--profile-bg);
    font-size: 14px;
    outline: none;
  }

  .profiles-search input:focus {
    background: #fff;
    box-shadow: 0 0 0 2px var(--profile-primary);
  }

  .profiles-scroll {
    flex: 1;
    overflow-y: auto;
  }

  /* Profil Kartı */
  .profile-card {
    display: flex;
    align-items: center;
    padding: 14px 20px;
    cursor: pointer;
    border-bottom: 1px solid var(--profile-border);
    transition: background 0.15s;
  }

  .profile-card:hover {
    background: var(--profile-bg);
  }

  .profile-card.active {
    background: #e7f8f5;
    border-left: 3px solid var(--profile-primary);
  }

  .profile-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    margin-right: 14px;
    object-fit: cover;
    background: #ddd;
  }

  .profile-info {
    flex: 1;
    min-width: 0;
  }

  .profile-name {
    font-weight: 600;
    font-size: 15px;
    color: var(--profile-text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .profile-phone {
    font-size: 13px;
    color: var(--profile-text-muted);
    margin-top: 2px;
  }

  .profile-meta {
    text-align: right;
  }

  .profile-time {
    font-size: 11px;
    color: var(--profile-text-muted);
  }

  .profile-badge {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 600;
    margin-top: 4px;
  }

  .badge-new { background: #e3f2fd; color: #1976d2; }
  .badge-collecting { background: #fff3e0; color: #f57c00; }
  .badge-waiting { background: #fce4ec; color: #c2185b; }
  .badge-scheduled { background: #e8f5e9; color: #388e3c; }
  .badge-called { background: #e0f7fa; color: #0097a7; }
  .badge-customer { background: #c8e6c9; color: #2e7d32; }
  .badge-admin { background: #ffcdd2; color: #c62828; }

  /* Sağ Panel - Detay */
  .profile-detail-panel {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: var(--profile-bg);
  }

  .detail-empty {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: var(--profile-text-muted);
    padding: 40px;
  }

  .detail-empty i {
    font-size: 80px;
    opacity: 0.3;
    margin-bottom: 20px;
  }

  .detail-header {
    display: flex;
    align-items: center;
    padding: 16px 24px;
    background: var(--profile-card-bg);
    border-bottom: 1px solid var(--profile-border);
    gap: 16px;
  }

  .detail-avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    object-fit: cover;
    background: #ddd;
  }

  .detail-title h4 {
    margin: 0 0 4px 0;
    font-weight: 600;
    font-size: 18px;
  }

  .detail-title small {
    color: var(--profile-text-muted);
    font-size: 14px;
  }

  .detail-actions {
    margin-left: auto;
    display: flex;
    gap: 8px;
  }

  .action-btn {
    padding: 8px 14px;
    border-radius: 8px;
    border: none;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s;
  }

  .action-btn-primary {
    background: var(--profile-primary);
    color: white;
  }

  .action-btn-primary:hover {
    background: #008f72;
  }

  .action-btn-danger {
    background: #fff;
    color: var(--profile-danger);
    border: 1px solid var(--profile-danger);
  }

  .action-btn-danger:hover {
    background: var(--profile-danger);
    color: white;
  }

  .action-btn-secondary {
    background: #fff;
    color: var(--profile-text);
    border: 1px solid var(--profile-border);
  }

  .action-btn-secondary:hover {
    background: var(--profile-bg);
  }

  .detail-content {
    flex: 1;
    display: flex;
    overflow: hidden;
  }

  /* Bilgi Paneli */
  .info-panel {
    width: 320px;
    background: var(--profile-card-bg);
    border-right: 1px solid var(--profile-border);
    overflow-y: auto;
    padding: 20px;
  }

  .info-section {
    margin-bottom: 20px;
  }

  .info-section-title {
    font-size: 12px;
    font-weight: 600;
    color: var(--profile-primary);
    text-transform: uppercase;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .info-row {
    display: flex;
    justify-content: space-between;
    padding: 10px 0;
    border-bottom: 1px solid var(--profile-border);
  }

  .info-label {
    font-size: 13px;
    color: var(--profile-text-muted);
  }

  .info-value {
    font-size: 13px;
    font-weight: 500;
    color: #000000;
    text-align: right;
    max-width: 60%;
    word-break: break-word;
  }

  .info-value.highlight {
    color: #c62828;
    font-weight: 600;
  }

  .status-select {
    padding: 6px 10px;
    border-radius: 6px;
    border: 1px solid var(--profile-border);
    font-size: 12px;
    cursor: pointer;
    background: white;
  }

  /* AI Analiz Kutusu */
  .ai-analysis-box {
    background: linear-gradient(135deg, #fff8e1 0%, #fffde7 100%);
    border: 1px solid #ffe082;
    border-radius: 10px;
    padding: 14px;
    margin-top: 12px;
  }

  .ai-analysis-box h6 {
    margin: 0 0 8px 0;
    font-size: 13px;
    color: #f9a825;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .ai-analysis-box p {
    margin: 0;
    font-size: 13px;
    color: #5d4037;
    line-height: 1.5;
    font-style: italic;
  }

  /* Mesaj Paneli */
  .messages-panel {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: var(--profile-bg);
    background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png");
    background-size: contain;
  }

  .messages-scroll {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
  }

  .msg-bubble {
    max-width: 65%;
    padding: 8px 12px;
    border-radius: 8px;
    margin-bottom: 6px;
    font-size: 14px;
    line-height: 1.4;
    position: relative;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    color: #000000;
  }

  .msg-bubble.incoming {
    background: white;
    align-self: flex-start;
    border-top-left-radius: 0;
    color: #000000;
  }

  .msg-bubble.outgoing {
    background: #d9fdd3;
    align-self: flex-end;
    border-top-right-radius: 0;
    color: #000000;
  }

  .msg-time {
    font-size: 10px;
    color: rgba(0,0,0,0.4);
    float: right;
    margin-left: 10px;
    margin-top: 4px;
  }

  .msg-date-divider {
    text-align: center;
    margin: 12px 0;
  }

  .msg-date-divider span {
    background: rgba(255,255,255,0.9);
    padding: 5px 12px;
    border-radius: 8px;
    font-size: 11px;
    color: var(--profile-text-muted);
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }

  /* Footer Input */
  .messages-footer {
    padding: 12px 20px;
    background: var(--profile-card-bg);
    display: flex;
    gap: 12px;
    align-items: center;
  }

  .messages-footer input {
    flex: 1;
    padding: 12px 16px;
    border-radius: 24px;
    border: none;
    background: var(--profile-bg);
    font-size: 14px;
    outline: none;
  }

  .messages-footer button {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    border: none;
    background: var(--profile-primary);
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.15s;
  }

  .messages-footer button:hover {
    transform: scale(1.05);
  }

  /* Responsive */
  @media (max-width: 1200px) {
    .info-panel {
      width: 280px;
    }
  }

  @media (max-width: 992px) {
    .profiles-list-panel {
      width: 300px;
    }
  }
</style>

<div class="content-header">
  <h2><i class="fas fa-users"></i> Profil Yonetimi</h2>
</div>

<div class="profiles-container">
  <!-- Sol Panel - Liste -->
  <div class="profiles-list-panel">
    <div class="profiles-header">
      <h5><i class="fas fa-address-book me-2"></i> Kisiler</h5>
      <span class="badge bg-primary" id="totalCount"><%= (activeProfiles || []).length + (completedProfiles || []).length %></span>
    </div>

    <div class="profiles-tabs">
      <button class="tab-btn active" data-tab="active" onclick="switchTab('active')">
        <i class="fas fa-clock me-1"></i> Aktif (<span id="activeCount"><%= (activeProfiles || []).length %></span>)
      </button>
      <button class="tab-btn" data-tab="completed" onclick="switchTab('completed')">
        <i class="fas fa-check me-1"></i> Tamamlanan (<span id="completedCount"><%= (completedProfiles || []).length %></span>)
      </button>
    </div>

    <div class="profiles-search">
      <input type="text" placeholder="Isim veya numara ara..." id="searchInput" oninput="filterProfiles()">
    </div>

    <div class="profiles-scroll" id="profilesList">
      <% const allProfiles = [...(activeProfiles || []), ...(completedProfiles || [])]; %>
      <% allProfiles.forEach((p, idx) => {
        const isCompleted = ['appointment_scheduled', 'called', 'customer'].includes(p.status);
        const statusLabels = {
          'new': 'Yeni', 'collecting': 'Bilgi', 'waiting': 'Bekliyor',
          'appointment_scheduled': 'Randevu', 'called': 'Arandi', 'customer': 'Musteri', 'admin': 'Admin'
        };
        const statusClasses = {
          'new': 'badge-new', 'collecting': 'badge-collecting', 'waiting': 'badge-waiting',
          'appointment_scheduled': 'badge-scheduled', 'called': 'badge-called', 'customer': 'badge-customer', 'admin': 'badge-admin'
        };
      %>
      <div class="profile-card"
           data-id="<%= p.id %>"
           data-chat-id="<%= p.chat_id %>"
           data-client-id="<%= p.client_id %>"
           data-tab="<%= isCompleted ? 'completed' : 'active' %>"
           onclick="selectProfile(this)">
        <img src="<%= p.profile_photo_url || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(p.full_name || 'U') + '&background=random' %>"
             class="profile-avatar"
             onerror="this.src='https://ui-avatars.com/api/?name=U&background=random'">
        <div class="profile-info">
          <div class="profile-name"><%= p.full_name || 'Isimsiz' %></div>
          <div class="profile-phone"><%= p.chat_id?.split('@')[0] || '-' %></div>
        </div>
        <div class="profile-meta">
          <div class="profile-time"><%= p.last_message_at ? new Date(p.last_message_at).toLocaleDateString('tr-TR') : '' %></div>
          <span class="profile-badge <%= statusClasses[p.status] || 'badge-new' %>"><%= statusLabels[p.status] || p.status %></span>
        </div>
      </div>
      <% }); %>
    </div>
  </div>

  <!-- Sag Panel - Detay -->
  <div class="profile-detail-panel" id="detailPanel">
    <div class="detail-empty">
      <i class="fas fa-user-circle"></i>
      <h4>Profil Secin</h4>
      <p>Detaylari gormek icin soldan bir kisi secin</p>
    </div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();
  let currentChatId = null;
  let currentClientId = null;
  let currentProfile = null;
  let currentTab = 'active';

  function switchTab(tab) {
    currentTab = tab;
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.tab === tab);
    });
    document.querySelectorAll('.profile-card').forEach(card => {
      card.style.display = card.dataset.tab === tab ? 'flex' : 'none';
    });
  }

  function filterProfiles() {
    const val = document.getElementById('searchInput').value.toLowerCase();
    document.querySelectorAll('.profile-card').forEach(card => {
      const text = card.innerText.toLowerCase();
      const matchesSearch = text.includes(val);
      const matchesTab = card.dataset.tab === currentTab;
      card.style.display = (matchesSearch && matchesTab) ? 'flex' : 'none';
    });
  }

  async function selectProfile(el) {
    document.querySelectorAll('.profile-card').forEach(c => c.classList.remove('active'));
    el.classList.add('active');

    currentChatId = el.dataset.chatId;
    currentClientId = el.dataset.clientId;

    const panel = document.getElementById('detailPanel');
    panel.innerHTML = '<div class="detail-empty"><div class="spinner-border text-primary"></div><p class="mt-3">Yukleniyor...</p></div>';

    try {
      const [profRes, msgRes] = await Promise.all([
        fetch(`/api/chat/${currentChatId}/profile`),
        fetch(`/api/chat/${currentChatId}/messages`)
      ]);

      const profData = await profRes.json();
      const msgData = await msgRes.json();

      if (profData.success) {
        currentProfile = profData.profile;
        renderDetail(currentProfile, msgData.messages || []);
      }
    } catch (e) {
      panel.innerHTML = '<div class="detail-empty"><i class="fas fa-exclamation-circle text-danger"></i><p>Yukleme hatasi</p></div>';
    }
  }

  function renderDetail(p, messages) {
    const panel = document.getElementById('detailPanel');
    const avatarUrl = p.profile_photo_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(p.full_name || 'U')}&background=random`;

    const statusOptions = [
      { value: 'new', label: 'Yeni' },
      { value: 'collecting', label: 'Bilgi Toplama' },
      { value: 'waiting', label: 'Bekliyor' },
      { value: 'appointment_scheduled', label: 'Randevu Alindi' },
      { value: 'called', label: 'Arandi' },
      { value: 'customer', label: 'Musteri' },
      { value: 'admin', label: 'Admin Devraldi' }
    ];

    panel.innerHTML = `
      <div class="detail-header">
        <img src="${avatarUrl}" class="detail-avatar" onerror="this.src='https://ui-avatars.com/api/?name=U&background=random'">
        <div class="detail-title">
          <h4>${p.full_name || 'Isimsiz'}</h4>
          <small>${p.chat_id?.split('@')[0] || '-'}</small>
        </div>
        <div class="detail-actions">
          <button class="action-btn action-btn-secondary" onclick="analyzeProfile()">
            <i class="fas fa-magic"></i> AI Analiz
          </button>
          <button class="action-btn action-btn-primary" onclick="openWhatsApp()">
            <i class="fab fa-whatsapp"></i> WhatsApp
          </button>
          <button class="action-btn action-btn-danger" onclick="toggleBlock()">
            <i class="fas fa-ban"></i> ${p.is_blocked ? 'Engeli Kaldir' : 'Engelle'}
          </button>
        </div>
      </div>

      <div class="detail-content">
        <div class="info-panel">
          <div class="info-section">
            <div class="info-section-title"><i class="fas fa-user"></i> Kisi Bilgileri</div>
            <div class="info-row">
              <span class="info-label">Isim</span>
              <span class="info-value">${p.full_name || '-'}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Telefon</span>
              <span class="info-value">${p.phone || p.chat_id?.split('@')[0] || '-'}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Sehir</span>
              <span class="info-value">${p.city || '-'}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Yas / Dogum</span>
              <span class="info-value">${p.birth_date || '-'}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Anne Adi</span>
              <span class="info-value">${p.mother_name || '-'}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Meslek</span>
              <span class="info-value">${p.job || '-'}</span>
            </div>
          </div>

          <div class="info-section">
            <div class="info-section-title"><i class="fas fa-exclamation-triangle"></i> Derdi / Sorunu</div>
            <div class="info-value highlight" style="padding: 10px 0; line-height: 1.5;">${p.subject || 'Henuz belirtilmemis'}</div>
          </div>

          <div class="info-section">
            <div class="info-section-title"><i class="fas fa-cog"></i> Durum</div>
            <div class="info-row">
              <span class="info-label">Mevcut Durum</span>
              <select class="status-select" onchange="changeStatus(this.value)">
                ${statusOptions.map(opt => `<option value="${opt.value}" ${p.status === opt.value ? 'selected' : ''}>${opt.label}</option>`).join('')}
              </select>
            </div>
            <div class="info-row">
              <span class="info-label">Mesaj Sayisi</span>
              <span class="info-value">${p.msg_count || 0}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Ilk Gorusme</span>
              <span class="info-value">${p.conversation_started_at ? new Date(p.conversation_started_at).toLocaleDateString('tr-TR') : '-'}</span>
            </div>
          </div>

          ${p.ai_analysis ? `
          <div class="ai-analysis-box">
            <h6><i class="fas fa-brain"></i> AI Karakter Analizi</h6>
            <p>${p.ai_analysis}</p>
          </div>
          ` : ''}
        </div>

        <div class="messages-panel">
          <div class="messages-scroll" id="messagesScroll">
            ${renderMessagesHTML(messages)}
          </div>
          <div class="messages-footer">
            <input type="text" id="messageInput" placeholder="Mesaj yaz..." onkeypress="if(event.key==='Enter')sendMessage()">
            <button onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
          </div>
        </div>
      </div>
    `;

    // Scroll to bottom
    const scroll = document.getElementById('messagesScroll');
    if (scroll) scroll.scrollTop = scroll.scrollHeight;
  }

  function renderMessagesHTML(messages) {
    if (!messages || messages.length === 0) {
      return '<div class="detail-empty" style="height:100%;"><i class="fas fa-comments" style="font-size:40px;"></i><p>Henuz mesaj yok</p></div>';
    }

    let html = '';
    let lastDate = '';

    messages.forEach(msg => {
      const date = new Date(msg.created_at);
      const dateStr = date.toLocaleDateString('tr-TR');
      const timeStr = date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
      const isMe = msg.direction === 'outgoing';

      if (dateStr !== lastDate) {
        html += `<div class="msg-date-divider"><span>${dateStr}</span></div>`;
        lastDate = dateStr;
      }

      html += `
        <div class="msg-bubble ${isMe ? 'outgoing' : 'incoming'}">
          ${msg.content || ''}
          <span class="msg-time">${timeStr}</span>
        </div>
      `;
    });

    return html;
  }

  async function changeStatus(status) {
    if (!currentChatId) return;
    try {
      await fetch(`/api/chat/${currentChatId}/status`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status })
      });
      // Update local state
      if (currentProfile) currentProfile.status = status;
    } catch (e) {
      alert('Durum guncellenemedi');
    }
  }

  async function toggleBlock() {
    if (!currentProfile || !currentChatId) return;
    const newState = !currentProfile.is_blocked;
    if (!confirm(newState ? 'Kisiyi engellemek istiyor musunuz?' : 'Engeli kaldirmak istiyor musunuz?')) return;

    try {
      await fetch(`/api/chat/${currentChatId}/block`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ blocked: newState })
      });
      currentProfile.is_blocked = newState;
      // Refresh
      const el = document.querySelector(`.profile-card[data-chat-id="${currentChatId}"]`);
      if (el) selectProfile(el);
    } catch (e) {
      alert('Islem basarisiz');
    }
  }

  async function analyzeProfile() {
    if (!currentChatId) return;
    const btn = event.currentTarget;
    const originalHTML = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analiz...';
    btn.disabled = true;

    try {
      const res = await fetch(`/api/chat/${currentChatId}/analyze`, { method: 'POST' });
      const data = await res.json();
      if (data.success) {
        currentProfile.ai_analysis = data.analysis;
        const el = document.querySelector(`.profile-card[data-chat-id="${currentChatId}"]`);
        if (el) selectProfile(el);
      } else {
        alert('Analiz yapilamadi: ' + (data.error || ''));
      }
    } catch (e) {
      alert('Analiz hatasi');
    }

    btn.innerHTML = originalHTML;
    btn.disabled = false;
  }

  function openWhatsApp() {
    window.open(`/whatsapp?chat=${currentChatId}`, '_blank');
  }

  async function sendMessage() {
    const input = document.getElementById('messageInput');
    const text = input.value.trim();
    if (!text || !currentChatId || !currentClientId) return;

    input.value = '';

    // Optimistic UI update
    const scroll = document.getElementById('messagesScroll');
    const time = new Date().toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
    scroll.innerHTML += `
      <div class="msg-bubble outgoing">
        ${text}
        <span class="msg-time">${time} <i class="fas fa-clock"></i></span>
      </div>
    `;
    scroll.scrollTop = scroll.scrollHeight;

    try {
      await fetch('/api/send', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ clientId: currentClientId, chatId: currentChatId, message: text })
      });
    } catch (e) {
      alert('Mesaj gonderilemedi');
    }
  }

  // Socket events
  socket.on('newMessage', (data) => {
    if (currentChatId === data.chatId) {
      const scroll = document.getElementById('messagesScroll');
      if (!scroll) return;

      const time = new Date(data.timestamp).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
      const isMe = data.direction === 'outgoing';

      scroll.innerHTML += `
        <div class="msg-bubble ${isMe ? 'outgoing' : 'incoming'}">
          ${data.body}
          <span class="msg-time">${time}</span>
        </div>
      `;
      scroll.scrollTop = scroll.scrollHeight;
    }
  });

  // Initial tab
  switchTab('active');
</script>

<%- include('partials/footer') %>
