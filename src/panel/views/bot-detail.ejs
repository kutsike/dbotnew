<%- include('partials/header', { title, page }) %>

<div class="content-header">
  <div style="display: flex; align-items: center; gap: 1rem;">
    <a href="/bots" class="btn btn-secondary btn-sm">
      <i class="fas fa-arrow-left"></i>
    </a>
    <h2><i class="fas fa-robot"></i> <%= client.name || client.id %></h2>
  </div>
  <div class="header-actions">
    <% if (client.frozen) { %>
      <button class="btn btn-success" onclick="unfreezeClient('<%= client.id %>')">
        <i class="fas fa-fire"></i> Aktif Et
      </button>
    <% } else { %>
      <button class="btn btn-warning" onclick="freezeClient('<%= client.id %>')">
        <i class="fas fa-snowflake"></i> Dondur
      </button>
    <% } %>
  </div>
</div>

<% if (saved) { %>
<div class="alert alert-success" style="margin-bottom: 1rem; padding: 0.75rem 1rem; background: #166534; border-radius: 0.5rem;">
  <i class="fas fa-check-circle"></i> Ayarlar kaydedildi!
</div>
<% } %>

<div class="grid-2">
  <!-- Sol Kolon: Bot Bilgileri -->
  <div class="card">
    <div class="card-header">
      <h3><i class="fas fa-info-circle"></i> Bot Bilgileri</h3>
    </div>
    <div class="card-body">
      <table class="info-table">
        <tr>
          <td><strong>ID:</strong></td>
          <td><code><%= client.id %></code></td>
        </tr>
        <tr>
          <td><strong>Ad:</strong></td>
          <td><%= client.name || '-' %></td>
        </tr>
        <tr>
          <td><strong>Telefon:</strong></td>
          <td><%= client.phone || '-' %></td>
        </tr>
        <tr>
          <td><strong>Durum:</strong></td>
          <td>
            <% if (client.status === 'ready') { %>
              <span class="badge badge-success"><i class="fas fa-check"></i> Aktif</span>
            <% } else if (client.status === 'qr_pending') { %>
              <span class="badge badge-warning"><i class="fas fa-qrcode"></i> QR Bekliyor</span>
            <% } else if (client.frozen) { %>
              <span class="badge badge-info"><i class="fas fa-snowflake"></i> Dondurulmuş</span>
            <% } else { %>
              <span class="badge badge-secondary"><%= client.status %></span>
            <% } %>
          </td>
        </tr>
        <tr>
          <td><strong>Kayıt:</strong></td>
          <td><%= new Date(client.created_at).toLocaleDateString('tr-TR') %></td>
        </tr>
      </table>

      <!-- İstatistikler -->
      <div class="stats-row">
        <div class="stat-box">
          <div class="stat-value"><%= stats.profiles %></div>
          <div class="stat-label">Profil</div>
        </div>
        <div class="stat-box">
          <div class="stat-value"><%= stats.messages %></div>
          <div class="stat-label">Mesaj</div>
        </div>
        <div class="stat-box">
          <div class="stat-value"><%= stats.todayMessages %></div>
          <div class="stat-label">Bugün</div>
        </div>
      </div>

      <!-- QR Kod -->
      <% if (client.qrCode) { %>
        <div class="qr-section">
          <h4><i class="fas fa-qrcode"></i> QR Kod</h4>
          <img src="<%= client.qrCode %>" alt="QR Code" class="qr-image">
          <p class="text-muted">WhatsApp'tan tarayın</p>
        </div>
      <% } %>
    </div>
  </div>

  <!-- Sağ Kolon: İnsanlaştırma Ayarları -->
  <div class="card">
    <div class="card-header">
      <h3><i class="fas fa-user-clock"></i> İnsanlaştırma Ayarları</h3>
      <span class="badge badge-<%= humanizationConfig._source === 'bot' ? 'primary' : 'secondary' %>">
        <%= humanizationConfig._source === 'bot' ? 'Bot Özel' : (humanizationConfig._source === 'global' ? 'Global' : 'Varsayılan') %>
      </span>
    </div>
    <div class="card-body">
      <form method="POST" action="/bots/<%= client.id %>/humanization">
        <div class="form-group">
          <label class="form-check-label">
            <input type="checkbox" name="enabled" <%= humanizationConfig.enabled ? 'checked' : '' %>>
            İnsanlaştırma Aktif
          </label>
        </div>

        <div class="row">
          <div class="col-6">
            <div class="form-group">
              <label class="form-label">Min Bekleme (sn)</label>
              <input type="number" name="min_response_delay" class="form-control"
                value="<%= humanizationConfig.min_response_delay %>" min="0">
            </div>
          </div>
          <div class="col-6">
            <div class="form-group">
              <label class="form-label">Max Bekleme (sn)</label>
              <input type="number" name="max_response_delay" class="form-control"
                value="<%= humanizationConfig.max_response_delay %>" min="0">
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-6">
            <div class="form-group">
              <label class="form-label">Okuma Hızı (WPM)</label>
              <input type="number" name="wpm_reading" class="form-control"
                value="<%= humanizationConfig.wpm_reading %>" min="50">
              <small class="form-text text-muted">Kelime/Dakika</small>
            </div>
          </div>
          <div class="col-6">
            <div class="form-group">
              <label class="form-label">Yazma Hızı (CPM)</label>
              <input type="number" name="cpm_typing" class="form-control"
                value="<%= humanizationConfig.cpm_typing %>" min="50">
              <small class="form-text text-muted">Karakter/Dakika</small>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-6">
            <div class="form-group">
              <label class="form-label">Uzun Mesaj Eşiği</label>
              <input type="number" name="long_message_threshold" class="form-control"
                value="<%= humanizationConfig.long_message_threshold %>" min="50">
            </div>
          </div>
          <div class="col-6">
            <div class="form-group">
              <label class="form-label">Uzun Mesaj Ek Bekleme (sn)</label>
              <input type="number" name="long_message_extra_delay" class="form-control"
                value="<%= humanizationConfig.long_message_extra_delay %>" min="0">
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-6">
            <div class="form-group">
              <label class="form-label">Yazma Varyansı (%)</label>
              <input type="number" name="typing_variance" class="form-control"
                value="<%= humanizationConfig.typing_variance %>" min="0" max="50">
            </div>
          </div>
          <div class="col-6">
            <div class="form-group">
              <label class="form-label">Mesaj Bölme Eşiği</label>
              <input type="number" name="split_threshold" class="form-control"
                value="<%= humanizationConfig.split_threshold || 240 %>" min="100">
            </div>
          </div>
        </div>

        <div class="form-group">
          <label class="form-check-label">
            <input type="checkbox" name="split_messages" <%= humanizationConfig.split_messages !== false ? 'checked' : '' %>>
            Uzun mesajları böl
          </label>
        </div>

        <div class="d-flex gap-2">
          <button type="submit" class="btn btn-primary flex-1">
            <i class="fas fa-save"></i> Kaydet
          </button>
          <button type="button" class="btn btn-secondary" onclick="clearHumanization('<%= client.id %>')">
            <i class="fas fa-undo"></i> Global Ayarlara Dön
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Anahtar Kelimeler Bölümü -->
<div class="card mt-3">
  <div class="card-header">
    <h3><i class="fas fa-key"></i> Anahtar Kelimeler</h3>
    <a href="/keywords" class="btn btn-primary btn-sm">
      <i class="fas fa-external-link-alt"></i> Tümünü Yönet
    </a>
  </div>
  <div class="card-body">
    <% if (keywords && keywords.length > 0) { %>
      <table class="table">
        <thead>
          <tr>
            <th>Anahtar Kelime</th>
            <th>Eşleşme</th>
            <th>Yanıt</th>
            <th>Kapsam</th>
            <th>Durum</th>
          </tr>
        </thead>
        <tbody>
          <% keywords.slice(0, 10).forEach(kw => { %>
            <tr class="<%= kw.is_active ? '' : 'row-inactive' %>">
              <td><strong><%= kw.keyword %></strong></td>
              <td>
                <% if (kw.match_type === 'exact') { %>
                  <span class="badge badge-info">Tam</span>
                <% } else if (kw.match_type === 'contains') { %>
                  <span class="badge badge-primary">İçerir</span>
                <% } else if (kw.match_type === 'startswith') { %>
                  <span class="badge badge-warning">Başlar</span>
                <% } else { %>
                  <span class="badge badge-danger">Regex</span>
                <% } %>
              </td>
              <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                <%= kw.response.substring(0, 60) %><%= kw.response.length > 60 ? '...' : '' %>
              </td>
              <td>
                <% if (kw.client_id === client.id) { %>
                  <span class="badge badge-primary">Bu Bot</span>
                <% } else { %>
                  <span class="badge badge-secondary">Tümü</span>
                <% } %>
              </td>
              <td>
                <% if (kw.is_active) { %>
                  <span class="badge badge-success">Aktif</span>
                <% } else { %>
                  <span class="badge badge-secondary">Pasif</span>
                <% } %>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
      <% if (keywords.length > 10) { %>
        <p class="text-muted text-center">... ve <%= keywords.length - 10 %> tane daha. <a href="/keywords">Tümünü gör</a></p>
      <% } %>
    <% } else { %>
      <div class="empty-state">
        <i class="fas fa-key"></i>
        <p>Bu bot için tanımlı anahtar kelime yok.</p>
        <a href="/keywords" class="btn btn-primary btn-sm">Anahtar Kelime Ekle</a>
      </div>
    <% } %>
  </div>
</div>

<!-- Dondurma Modalı -->
<div id="freezeModal" class="modal-overlay" style="display: none;">
  <div class="card modal-card">
    <div class="card-header">
      <h3><i class="fas fa-snowflake"></i> Botu Dondur</h3>
      <button class="btn btn-sm btn-secondary" onclick="closeFreezeModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="card-body">
      <form id="freezeForm">
        <div class="form-group">
          <label class="form-label">Dondurma Mesajı</label>
          <textarea name="message" class="form-control" rows="3"
            placeholder="Şu an müsait değilim, biraz sonra tekrar yazabilir misiniz?"></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Yönlendirme Telefonu (opsiyonel)</label>
          <input type="text" name="redirectPhone" class="form-control" placeholder="+905xxxxxxxxx">
        </div>
        <button type="submit" class="btn btn-warning w-100">
          <i class="fas fa-snowflake"></i> Dondur
        </button>
      </form>
    </div>
  </div>
</div>

<style>
.grid-2 {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1.5rem;
}
@media (max-width: 900px) {
  .grid-2 { grid-template-columns: 1fr; }
}
.info-table {
  width: 100%;
  margin-bottom: 1rem;
}
.info-table td {
  padding: 0.5rem 0;
  border-bottom: 1px solid #334155;
}
.info-table td:first-child {
  width: 120px;
  color: #94a3b8;
}
.stats-row {
  display: flex;
  gap: 1rem;
  margin: 1.5rem 0;
}
.stat-box {
  flex: 1;
  text-align: center;
  padding: 1rem;
  background: #1e293b;
  border-radius: 0.5rem;
}
.stat-value {
  font-size: 1.5rem;
  font-weight: 700;
  color: #4ade80;
}
.stat-label {
  font-size: 0.8rem;
  color: #94a3b8;
}
.qr-section {
  text-align: center;
  padding: 1rem;
  background: #1e293b;
  border-radius: 0.5rem;
  margin-top: 1rem;
}
.qr-section h4 {
  margin-bottom: 1rem;
  color: #e2e8f0;
}
.qr-image {
  max-width: 200px;
  border-radius: 0.5rem;
}
.row {
  display: flex;
  gap: 1rem;
}
.col-6 {
  flex: 1;
}
.flex-1 {
  flex: 1;
}
.mt-3 {
  margin-top: 1.5rem;
}
.row-inactive {
  opacity: 0.5;
}
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.8);
  z-index: 1000;
  padding: 2rem;
  overflow-y: auto;
}
.modal-card {
  max-width: 500px;
  margin: 2rem auto;
}
.alert-success {
  color: #bbf7d0;
}
</style>

<script>
const clientId = '<%= client.id %>';

function freezeClient(id) {
  document.getElementById('freezeModal').style.display = 'block';
}

function closeFreezeModal() {
  document.getElementById('freezeModal').style.display = 'none';
}

document.getElementById('freezeForm')?.addEventListener('submit', async (e) => {
  e.preventDefault();
  const formData = new FormData(e.target);
  const data = {
    message: formData.get('message'),
    redirectPhone: formData.get('redirectPhone')
  };

  try {
    const res = await fetch(`/api/clients/${clientId}/freeze`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    const result = await res.json();
    if (result.success) {
      showToast('Başarılı', 'Bot donduruldu', 'success');
      setTimeout(() => location.reload(), 500);
    } else {
      showToast('Hata', result.error || 'Bir hata oluştu', 'error');
    }
  } catch (err) {
    showToast('Hata', 'Sunucu hatası', 'error');
  }
});

async function unfreezeClient(id) {
  try {
    const res = await fetch(`/api/clients/${id}/unfreeze`, { method: 'POST' });
    const result = await res.json();
    if (result.success) {
      showToast('Başarılı', 'Bot aktif edildi', 'success');
      setTimeout(() => location.reload(), 500);
    } else {
      showToast('Hata', result.error || 'Bir hata oluştu', 'error');
    }
  } catch (err) {
    showToast('Hata', 'Sunucu hatası', 'error');
  }
}

async function clearHumanization(id) {
  if (!confirm('Bu botun özel ayarları silinecek ve global ayarlara dönülecek. Emin misiniz?')) return;

  try {
    const res = await fetch(`/api/clients/${id}/humanization`, { method: 'DELETE' });
    const result = await res.json();
    if (result.success) {
      showToast('Başarılı', 'Bot global ayarlara döndürüldü', 'success');
      setTimeout(() => location.reload(), 500);
    } else {
      showToast('Hata', result.error || 'Bir hata oluştu', 'error');
    }
  } catch (err) {
    showToast('Hata', 'Sunucu hatası', 'error');
  }
}

document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') closeFreezeModal();
});
</script>

<%- include('partials/footer') %>
