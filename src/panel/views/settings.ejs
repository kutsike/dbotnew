<%- include('partials/header', { title, page }) %>

<style>
  .settings-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 1.5rem;
  }
  .settings-section {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    overflow: hidden;
  }
  .settings-section-header {
    padding: 1rem 1.5rem;
    background: rgba(255,255,255,0.02);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }
  .settings-section-header i {
    font-size: 1.25rem;
    color: var(--primary);
  }
  .settings-section-header h3 {
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
  }
  .settings-section-body {
    padding: 1.5rem;
  }
  .setting-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 0;
    border-bottom: 1px solid rgba(255,255,255,0.05);
  }
  .setting-item:last-child {
    border-bottom: none;
    padding-bottom: 0;
  }
  .setting-item:first-child {
    padding-top: 0;
  }
  .setting-info {
    flex: 1;
  }
  .setting-title {
    font-weight: 500;
    margin-bottom: 0.25rem;
  }
  .setting-desc {
    font-size: 0.85rem;
    color: var(--text-muted);
  }
  .setting-action {
    margin-left: 1rem;
  }
  .status-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.4rem 0.85rem;
    border-radius: 50px;
    font-size: 0.8rem;
    font-weight: 500;
  }
  .status-badge.online {
    background: rgba(34, 197, 94, 0.15);
    color: #22c55e;
  }
  .status-badge.offline {
    background: rgba(239, 68, 68, 0.15);
    color: #ef4444;
  }
  .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: currentColor;
  }
  .behavior-log {
    background: var(--bg-darker);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    padding: 1rem;
    max-height: 300px;
    overflow-y: auto;
    font-family: 'Monaco', 'Menlo', monospace;
    font-size: 0.85rem;
  }
  .behavior-entry {
    padding: 0.5rem 0;
    border-bottom: 1px solid rgba(255,255,255,0.05);
  }
  .behavior-entry:last-child {
    border-bottom: none;
  }
  .behavior-time {
    color: var(--text-muted);
    font-size: 0.75rem;
  }
  .behavior-action {
    color: var(--primary);
    font-weight: 500;
  }
  .behavior-detail {
    color: var(--text-secondary);
    margin-top: 0.25rem;
  }
  .notification-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.75rem 0;
  }
  .notification-icon {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
  }
  .notification-icon.message { background: rgba(0, 217, 165, 0.15); color: var(--primary); }
  .notification-icon.appointment { background: rgba(56, 189, 248, 0.15); color: #38bdf8; }
  .notification-icon.system { background: rgba(251, 191, 36, 0.15); color: #fbbf24; }
  .quick-actions {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
  }
  .quick-action-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.75rem;
    padding: 1.5rem 1rem;
    background: var(--bg-darker);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all 0.2s ease;
    color: var(--text-secondary);
  }
  .quick-action-btn:hover {
    background: var(--bg-hover);
    border-color: var(--primary);
    color: var(--primary);
  }
  .quick-action-btn.danger:hover {
    border-color: var(--danger);
    color: var(--danger);
  }
  .quick-action-btn i {
    font-size: 1.5rem;
  }
  .quick-action-btn span {
    font-size: 0.85rem;
    font-weight: 500;
  }
  .tabs-container {
    margin-bottom: 1.5rem;
  }
  .tabs-nav {
    display: flex;
    gap: 0;
    border-bottom: 1px solid var(--border);
    overflow-x: auto;
  }
  .tab-btn {
    padding: 1rem 1.5rem;
    background: transparent;
    border: none;
    color: var(--text-muted);
    font-weight: 500;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s ease;
    white-space: nowrap;
  }
  .tab-btn:hover {
    color: var(--text-main);
    background: rgba(255,255,255,0.02);
  }
  .tab-btn.active {
    color: var(--primary);
    border-bottom-color: var(--primary);
  }
  .tab-content {
    display: none;
    animation: fadeIn 0.3s ease;
  }
  .tab-content.active {
    display: block;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .stat-mini {
    text-align: center;
    padding: 1rem;
    background: var(--bg-darker);
    border-radius: var(--radius-md);
  }
  .stat-mini-value {
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--primary);
  }
  .stat-mini-label {
    font-size: 0.8rem;
    color: var(--text-muted);
    margin-top: 0.25rem;
  }
  .password-strength {
    height: 4px;
    background: var(--border);
    border-radius: 2px;
    margin-top: 0.5rem;
    overflow: hidden;
  }
  .password-strength-bar {
    height: 100%;
    transition: width 0.3s, background 0.3s;
    border-radius: 2px;
  }
</style>

<div class="content-header">
  <h2><i class="fas fa-cogs"></i> Sistem AyarlarÄ±</h2>
  <div class="header-actions">
    <span class="status-badge online" id="systemStatus">
      <span class="status-dot"></span>
      <span>Sistem Aktif</span>
    </span>
  </div>
</div>

<!-- Tab Navigation -->
<div class="tabs-container">
  <div class="tabs-nav">
    <button class="tab-btn active" onclick="switchTab('general')">
      <i class="fas fa-sliders-h"></i> Genel
    </button>
    <button class="tab-btn" onclick="switchTab('bot')">
      <i class="fas fa-robot"></i> Bot KontrolÃ¼
    </button>
    <button class="tab-btn" onclick="switchTab('behavior')">
      <i class="fas fa-brain"></i> DavranÄ±ÅŸ Analizi
    </button>
    <button class="tab-btn" onclick="switchTab('notifications')">
      <i class="fas fa-bell"></i> Bildirimler
    </button>
    <button class="tab-btn" onclick="switchTab('security')">
      <i class="fas fa-shield-alt"></i> GÃ¼venlik
    </button>
    <button class="tab-btn" onclick="switchTab('messages')">
      <i class="fas fa-comment-dots"></i> Mesajlar
    </button>
  </div>
</div>

<!-- GENEL TAB -->
<div class="tab-content active" id="tab-general">
  <div class="settings-grid">
    <!-- HÄ±zlÄ± Ä°ÅŸlemler -->
    <div class="settings-section">
      <div class="settings-section-header">
        <i class="fas fa-bolt"></i>
        <h3>HÄ±zlÄ± Ä°ÅŸlemler</h3>
      </div>
      <div class="settings-section-body">
        <div class="quick-actions">
          <div class="quick-action-btn" onclick="restartBot()">
            <i class="fas fa-sync-alt"></i>
            <span>Botu Yeniden BaÅŸlat</span>
          </div>
          <div class="quick-action-btn" onclick="clearCache()">
            <i class="fas fa-broom"></i>
            <span>Ã–nbellek Temizle</span>
          </div>
          <div class="quick-action-btn" onclick="exportData()">
            <i class="fas fa-download"></i>
            <span>Verileri DÄ±ÅŸa Aktar</span>
          </div>
          <div class="quick-action-btn danger" onclick="showClearChatsModal()">
            <i class="fas fa-trash-alt"></i>
            <span>Mesaj Silme</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Mesaj Silme BÃ¶lÃ¼mÃ¼ -->
    <div class="settings-section">
      <div class="settings-section-header">
        <i class="fas fa-trash-alt"></i>
        <h3>Mesaj Silme Ä°ÅŸlemleri</h3>
      </div>
      <div class="settings-section-body">
        <div class="form-group">
          <label class="form-label">Bot SeÃ§imi</label>
          <select id="clearBotSelect" class="form-control form-select">
            <option value="">TÃ¼m Botlar</option>
          </select>
          <small class="text-muted">Belirli bir bot seÃ§erek sadece o bot'un mesajlarÄ±nÄ± silebilirsiniz</small>
        </div>
        <div class="form-group" style="margin-top: 1rem;">
          <label class="form-label">Tarih AralÄ±ÄŸÄ±</label>
          <select id="deleteTimeRange" class="form-control form-select">
            <option value="1h">Son 1 Saat</option>
            <option value="24h">Son 24 Saat</option>
            <option value="7d">Son 1 Hafta</option>
            <option value="30d" selected>Son 1 Ay</option>
            <option value="90d">Son 3 Ay</option>
            <option value="all">TÃ¼m Mesajlar</option>
          </select>
          <small class="text-muted">Silinecek mesajlarÄ±n tarih aralÄ±ÄŸÄ±nÄ± seÃ§in</small>
        </div>
        <div class="setting-item" style="padding: 1rem 0;">
          <div class="setting-info">
            <div class="setting-title">WhatsApp'tan da Sil</div>
            <div class="setting-desc">MesajlarÄ± WhatsApp sohbetlerinden de temizle</div>
          </div>
          <div class="setting-action">
            <label class="switch">
              <input type="checkbox" id="deleteFromWhatsApp">
              <span class="slider"></span>
            </label>
          </div>
        </div>
        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
          <button class="btn btn-warning" onclick="clearSelectedChats()">
            <i class="fas fa-eraser"></i> MesajlarÄ± Temizle
          </button>
        </div>
      </div>
    </div>

    <!-- Sistem Durumu -->
    <div class="settings-section">
      <div class="settings-section-header">
        <i class="fas fa-heartbeat"></i>
        <h3>Sistem Durumu</h3>
      </div>
      <div class="settings-section-body">
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1rem;">
          <div class="stat-mini">
            <div class="stat-mini-value" id="activeBots">0</div>
            <div class="stat-mini-label">Aktif Bot</div>
          </div>
          <div class="stat-mini">
            <div class="stat-mini-value" id="todayMessages">0</div>
            <div class="stat-mini-label">BugÃ¼n Mesaj</div>
          </div>
          <div class="stat-mini">
            <div class="stat-mini-value" id="cacheSize">0 MB</div>
            <div class="stat-mini-label">Ã–nbellek</div>
          </div>
        </div>
        <div class="setting-item">
          <div class="setting-info">
            <div class="setting-title">Sunucu Ã‡alÄ±ÅŸma SÃ¼resi</div>
            <div class="setting-desc" id="uptime">HesaplanÄ±yor...</div>
          </div>
        </div>
        <div class="setting-item">
          <div class="setting-info">
            <div class="setting-title">Son Yedekleme</div>
            <div class="setting-desc" id="lastBackup">HenÃ¼z yapÄ±lmadÄ±</div>
          </div>
          <div class="setting-action">
            <button class="btn btn-sm btn-secondary" onclick="createBackup()">
              <i class="fas fa-database"></i> Yedekle
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- BOT KONTROLÃœ TAB -->
<div class="tab-content" id="tab-bot">
  <div class="settings-grid">
    <!-- Bot Durumu -->
    <div class="settings-section">
      <div class="settings-section-header">
        <i class="fas fa-power-off"></i>
        <h3>Bot Durumu</h3>
      </div>
      <div class="settings-section-body">
        <div class="setting-item">
          <div class="setting-info">
            <div class="setting-title">Ana Bot</div>
            <div class="setting-desc">WhatsApp baÄŸlantÄ± durumu</div>
          </div>
          <div class="setting-action">
            <span class="status-badge online" id="botStatus">
              <span class="status-dot"></span>
              <span>BaÄŸlÄ±</span>
            </span>
          </div>
        </div>
        <div class="setting-item">
          <div class="setting-info">
            <div class="setting-title">Otomatik YanÄ±t</div>
            <div class="setting-desc">Gelen mesajlara otomatik yanÄ±t ver</div>
          </div>
          <div class="setting-action">
            <label class="switch">
              <input type="checkbox" id="autoReply" checked>
              <span class="slider"></span>
            </label>
          </div>
        </div>
        <div class="setting-item">
          <div class="setting-info">
            <div class="setting-title">AI Modu</div>
            <div class="setting-desc">Yapay zeka ile akÄ±llÄ± yanÄ±tlar</div>
          </div>
          <div class="setting-action">
            <label class="switch">
              <input type="checkbox" id="aiMode" checked>
              <span class="slider"></span>
            </label>
          </div>
        </div>
        <div class="setting-item">
          <div class="setting-info">
            <div class="setting-title">Mesai Saatleri</div>
            <div class="setting-desc">Sadece belirli saatlerde yanÄ±t ver</div>
          </div>
          <div class="setting-action">
            <label class="switch">
              <input type="checkbox" id="workingHours">
              <span class="slider"></span>
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- Bot Kontrolleri -->
    <div class="settings-section">
      <div class="settings-section-header">
        <i class="fas fa-gamepad"></i>
        <h3>Bot Kontrolleri</h3>
      </div>
      <div class="settings-section-body">
        <div class="quick-actions">
          <div class="quick-action-btn" onclick="restartBot()">
            <i class="fas fa-redo"></i>
            <span>Yeniden BaÅŸlat</span>
          </div>
          <div class="quick-action-btn" onclick="pauseBot()">
            <i class="fas fa-pause"></i>
            <span>Duraklat</span>
          </div>
          <div class="quick-action-btn" onclick="reconnectWhatsApp()">
            <i class="fab fa-whatsapp"></i>
            <span>WhatsApp BaÄŸlan</span>
          </div>
          <div class="quick-action-btn" onclick="showQRCode()">
            <i class="fas fa-qrcode"></i>
            <span>QR Kod GÃ¶ster</span>
          </div>
        </div>
        <div class="form-group" style="margin-top: 1.5rem;">
          <label class="form-label">Mesai Saatleri</label>
          <div style="display: flex; gap: 1rem;">
            <input type="time" id="workStart" class="form-control" value="09:00">
            <span style="align-self: center;">-</span>
            <input type="time" id="workEnd" class="form-control" value="18:00">
          </div>
        </div>
      </div>
    </div>

    <!-- Botu Ä°mha Et -->
    <div class="settings-section" style="border: 2px solid rgba(239, 68, 68, 0.3);">
      <div class="settings-section-header" style="background: rgba(239, 68, 68, 0.1);">
        <i class="fas fa-skull-crossbones" style="color: #ef4444;"></i>
        <h3 style="color: #ef4444;">Botu Ä°mha Et</h3>
      </div>
      <div class="settings-section-body">
        <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
          <p style="color: #ef4444; margin: 0; font-weight: 500;">
            <i class="fas fa-exclamation-triangle"></i> DÄ°KKAT: Bu iÅŸlem geri alÄ±namaz!
          </p>
          <small style="color: var(--text-muted);">
            Bot imha edildiÄŸinde: TÃ¼m mesajlar silinir, WhatsApp oturumu kapatÄ±lÄ±r, session dosyalarÄ± temizlenir.
          </small>
        </div>
        <div class="form-group">
          <label class="form-label">Ä°mha Edilecek Bot</label>
          <select id="destroyBotSelect" class="form-control form-select">
            <option value="">Bot SeÃ§in...</option>
          </select>
        </div>
        <div class="setting-item" style="padding: 1rem 0;">
          <div class="setting-info">
            <div class="setting-title">WhatsApp Sohbetlerini de Temizle</div>
            <div class="setting-desc">Bot'un tÃ¼m WhatsApp sohbetlerini de temizle</div>
          </div>
          <div class="setting-action">
            <label class="switch">
              <input type="checkbox" id="destroyDeleteFromWA">
              <span class="slider"></span>
            </label>
          </div>
        </div>
        <div class="setting-item" style="padding: 1rem 0;">
          <div class="setting-info">
            <div class="setting-title">WhatsApp HesabÄ±ndan Ã‡Ä±kÄ±ÅŸ</div>
            <div class="setting-desc">WhatsApp hesabÄ±ndan Ã§Ä±kÄ±ÅŸ yap (QR kod ile tekrar baÄŸlanÄ±lmasÄ± gerekir)</div>
          </div>
          <div class="setting-action">
            <label class="switch">
              <input type="checkbox" id="destroyLogoutWA" checked>
              <span class="slider"></span>
            </label>
          </div>
        </div>
        <button class="btn btn-danger" onclick="destroyBot()" style="width: 100%; margin-top: 1rem;">
          <i class="fas fa-skull"></i> Botu Ä°mha Et
        </button>
      </div>
    </div>
  </div>
</div>

<!-- DAVRANIS ANALÄ°ZÄ° TAB -->
<div class="tab-content" id="tab-behavior">
  <div class="settings-grid">
    <!-- DavranÄ±ÅŸ Logu -->
    <div class="settings-section" style="grid-column: span 2;">
      <div class="settings-section-header">
        <i class="fas fa-chart-line"></i>
        <h3>Bot DavranÄ±ÅŸ Analizi</h3>
        <button class="btn btn-sm btn-secondary" style="margin-left: auto;" onclick="refreshBehaviorLog()">
          <i class="fas fa-sync-alt"></i> Yenile
        </button>
      </div>
      <div class="settings-section-body">
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
          <div class="stat-mini">
            <div class="stat-mini-value" id="totalResponses">0</div>
            <div class="stat-mini-label">Toplam YanÄ±t</div>
          </div>
          <div class="stat-mini">
            <div class="stat-mini-value" id="avgResponseTime">0s</div>
            <div class="stat-mini-label">Ort. YanÄ±t SÃ¼resi</div>
          </div>
          <div class="stat-mini">
            <div class="stat-mini-value" id="keywordMatches">0</div>
            <div class="stat-mini-label">Anahtar Kelime EÅŸleÅŸmesi</div>
          </div>
          <div class="stat-mini">
            <div class="stat-mini-value" id="aiResponses">0</div>
            <div class="stat-mini-label">AI YanÄ±tÄ±</div>
          </div>
        </div>

        <label class="form-label">Son Bot Aktiviteleri</label>
        <div class="behavior-log" id="behaviorLog">
          <div class="behavior-entry">
            <div class="behavior-time">YÃ¼kleniyor...</div>
          </div>
        </div>

        <div class="form-group" style="margin-top: 1.5rem;">
          <label class="form-label">DavranÄ±ÅŸ Testi</label>
          <div style="display: flex; gap: 1rem;">
            <input type="text" id="testMessage" class="form-control" placeholder="Test mesajÄ± yazÄ±n...">
            <button class="btn btn-primary" onclick="testBehavior()">
              <i class="fas fa-flask"></i> Test Et
            </button>
          </div>
          <div id="behaviorTestResult" style="margin-top: 1rem; display: none;" class="behavior-log"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- BÄ°LDÄ°RÄ°MLER TAB -->
<div class="tab-content" id="tab-notifications">
  <div class="settings-grid">
    <!-- Bildirim AyarlarÄ± -->
    <div class="settings-section">
      <div class="settings-section-header">
        <i class="fas fa-bell"></i>
        <h3>Bildirim Tercihleri</h3>
      </div>
      <div class="settings-section-body">
        <div class="setting-item">
          <div class="setting-info">
            <div class="setting-title">Push Bildirimleri</div>
            <div class="setting-desc">TarayÄ±cÄ± bildirimleri al</div>
          </div>
          <div class="setting-action">
            <label class="switch">
              <input type="checkbox" id="pushNotifications" onchange="togglePushNotifications()">
              <span class="slider"></span>
            </label>
          </div>
        </div>
        <div class="setting-item">
          <div class="setting-info">
            <div class="setting-title">Yeni Mesaj Bildirimi</div>
            <div class="setting-desc">Yeni mesaj geldiÄŸinde bildir</div>
          </div>
          <div class="setting-action">
            <label class="switch">
              <input type="checkbox" id="notifyNewMessage" checked>
              <span class="slider"></span>
            </label>
          </div>
        </div>
        <div class="setting-item">
          <div class="setting-info">
            <div class="setting-title">Randevu Bildirimi</div>
            <div class="setting-desc">Yeni randevu oluÅŸtuÄŸunda bildir</div>
          </div>
          <div class="setting-action">
            <label class="switch">
              <input type="checkbox" id="notifyAppointment" checked>
              <span class="slider"></span>
            </label>
          </div>
        </div>
        <div class="setting-item">
          <div class="setting-info">
            <div class="setting-title">Sistem Bildirimleri</div>
            <div class="setting-desc">Bot durumu deÄŸiÅŸikliklerini bildir</div>
          </div>
          <div class="setting-action">
            <label class="switch">
              <input type="checkbox" id="notifySystem" checked>
              <span class="slider"></span>
            </label>
          </div>
        </div>
        <div class="setting-item">
          <div class="setting-info">
            <div class="setting-title">Ses</div>
            <div class="setting-desc">Bildirim sesi Ã§al</div>
          </div>
          <div class="setting-action">
            <label class="switch">
              <input type="checkbox" id="notifySound" checked>
              <span class="slider"></span>
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- Son Bildirimler -->
    <div class="settings-section">
      <div class="settings-section-header">
        <i class="fas fa-history"></i>
        <h3>Son Bildirimler</h3>
      </div>
      <div class="settings-section-body">
        <div id="recentNotifications">
          <div class="notification-item">
            <div class="notification-icon message"><i class="fas fa-comment"></i></div>
            <div class="setting-info">
              <div class="setting-title">Yeni mesaj</div>
              <div class="setting-desc">Ahmet K. bir mesaj gÃ¶nderdi</div>
            </div>
            <small class="text-muted">2 dk Ã¶nce</small>
          </div>
          <div class="notification-item">
            <div class="notification-icon appointment"><i class="fas fa-calendar"></i></div>
            <div class="setting-info">
              <div class="setting-title">Yeni randevu</div>
              <div class="setting-desc">Mehmet B. randevu oluÅŸturdu</div>
            </div>
            <small class="text-muted">15 dk Ã¶nce</small>
          </div>
          <div class="notification-item">
            <div class="notification-icon system"><i class="fas fa-cog"></i></div>
            <div class="setting-info">
              <div class="setting-title">Bot yeniden baÅŸlatÄ±ldÄ±</div>
              <div class="setting-desc">Sistem otomatik yeniden baÅŸlatma</div>
            </div>
            <small class="text-muted">1 saat Ã¶nce</small>
          </div>
        </div>
        <button class="btn btn-secondary btn-sm w-100" style="margin-top: 1rem;" onclick="testNotification()">
          <i class="fas fa-bell"></i> Test Bildirimi GÃ¶nder
        </button>
      </div>
    </div>
  </div>
</div>

<!-- GÃœVENLÄ°K TAB -->
<div class="tab-content" id="tab-security">
  <div class="settings-grid">
    <!-- Parola DeÄŸiÅŸtir -->
    <div class="settings-section">
      <div class="settings-section-header">
        <i class="fas fa-key"></i>
        <h3>Parola DeÄŸiÅŸtir</h3>
      </div>
      <div class="settings-section-body">
        <form id="passwordForm" onsubmit="changePassword(event)">
          <div class="form-group">
            <label class="form-label">Mevcut Parola</label>
            <input type="password" id="currentPassword" class="form-control" required>
          </div>
          <div class="form-group">
            <label class="form-label">Yeni Parola</label>
            <input type="password" id="newPassword" class="form-control" required oninput="checkPasswordStrength()">
            <div class="password-strength">
              <div class="password-strength-bar" id="passwordStrengthBar"></div>
            </div>
            <small class="text-muted" id="passwordStrengthText">Parola gÃ¼cÃ¼: -</small>
          </div>
          <div class="form-group">
            <label class="form-label">Yeni Parola (Tekrar)</label>
            <input type="password" id="confirmPassword" class="form-control" required>
          </div>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save"></i> ParolayÄ± DeÄŸiÅŸtir
          </button>
        </form>
      </div>
    </div>

    <!-- GÃ¼venlik AyarlarÄ± -->
    <div class="settings-section">
      <div class="settings-section-header">
        <i class="fas fa-shield-alt"></i>
        <h3>GÃ¼venlik AyarlarÄ±</h3>
      </div>
      <div class="settings-section-body">
        <div class="setting-item">
          <div class="setting-info">
            <div class="setting-title">Ä°ki FaktÃ¶rlÃ¼ DoÄŸrulama</div>
            <div class="setting-desc">WhatsApp Ã¼zerinden doÄŸrulama kodu al</div>
          </div>
          <div class="setting-action">
            <label class="switch">
              <input type="checkbox" id="twoFactor" onchange="toggle2FA()">
              <span class="slider"></span>
            </label>
          </div>
        </div>
        <div class="setting-item">
          <div class="setting-info">
            <div class="setting-title">Oturum Zaman AÅŸÄ±mÄ±</div>
            <div class="setting-desc">Otomatik Ã§Ä±kÄ±ÅŸ sÃ¼resi</div>
          </div>
          <div class="setting-action">
            <select class="form-control form-select" id="sessionTimeout" style="width: auto;" onchange="saveSecuritySetting('session_timeout', this.value)">
              <option value="30">30 dakika</option>
              <option value="60" selected>1 saat</option>
              <option value="240">4 saat</option>
              <option value="1440">1 gÃ¼n</option>
            </select>
          </div>
        </div>
        <div class="setting-item">
          <div class="setting-info">
            <div class="setting-title">IP KÄ±sÄ±tlamasÄ±</div>
            <div class="setting-desc">Sadece belirli IP'lerden eriÅŸim</div>
          </div>
          <div class="setting-action">
            <label class="switch">
              <input type="checkbox" id="ipRestriction" onchange="toggleIPRestriction()">
              <span class="slider"></span>
            </label>
          </div>
        </div>
        <div style="margin-top: 1.5rem;">
          <button class="btn btn-danger btn-sm" onclick="logoutAllDevices()">
            <i class="fas fa-sign-out-alt"></i> TÃ¼m Cihazlardan Ã‡Ä±kÄ±ÅŸ Yap
          </button>
          <button class="btn btn-warning btn-sm" onclick="resetSettings()" style="margin-left: 0.5rem;">
            <i class="fas fa-undo"></i> AyarlarÄ± SÄ±fÄ±rla
          </button>
        </div>
      </div>
    </div>

    <!-- Magic Link -->
    <div class="settings-section">
      <div class="settings-section-header">
        <i class="fas fa-magic"></i>
        <h3>Magic Link GiriÅŸi</h3>
      </div>
      <div class="settings-section-body">
        <div class="setting-item">
          <div class="setting-info">
            <div class="setting-title">Magic Link Aktif</div>
            <div class="setting-desc">Ana bot'a <code>!panel</code> yazarak giriÅŸ linki al</div>
          </div>
          <div class="setting-action">
            <label class="switch">
              <input type="checkbox" id="magicLinkEnabled" onchange="toggleMagicLink()" checked>
              <span class="slider"></span>
            </label>
          </div>
        </div>
        <div class="setting-item">
          <div class="setting-info">
            <div class="setting-title">Link GeÃ§erlilik SÃ¼resi</div>
            <div class="setting-desc">Magic link'in geÃ§erli olacaÄŸÄ± sÃ¼re</div>
          </div>
          <div class="setting-action">
            <select class="form-control form-select" id="magicLinkExpiry" style="width: auto;" onchange="saveSecuritySetting('magic_link_expiry', this.value)">
              <option value="5">5 dakika</option>
              <option value="15" selected>15 dakika</option>
              <option value="30">30 dakika</option>
              <option value="60">1 saat</option>
            </select>
          </div>
        </div>
        <div class="setting-item">
          <div class="setting-info">
            <div class="setting-title">Yetkili Numaralar</div>
            <div class="setting-desc">Magic link oluÅŸturabilecek numaralar (virgÃ¼lle ayÄ±r)</div>
          </div>
        </div>
        <div class="form-group" style="margin-top: 0.5rem;">
          <input type="text" id="authorizedNumbers" class="form-control" placeholder="905551234567, 905559876543" onchange="saveSecuritySetting('authorized_numbers', this.value)">
          <small class="text-muted">BoÅŸ bÄ±rakÄ±lÄ±rsa herkes magic link oluÅŸturabilir</small>
        </div>
        <div style="margin-top: 1rem;">
          <button class="btn btn-primary btn-sm" onclick="generateMagicLink()">
            <i class="fas fa-link"></i> Manuel Link OluÅŸtur
          </button>
          <div id="magicLinkResult" style="margin-top: 1rem; display: none;">
            <div class="form-group">
              <label class="form-label">OluÅŸturulan Link:</label>
              <div style="display: flex; gap: 0.5rem;">
                <input type="text" id="generatedLink" class="form-control" readonly>
                <button class="btn btn-secondary" onclick="copyMagicLink()">
                  <i class="fas fa-copy"></i>
                </button>
              </div>
              <small class="text-muted" id="linkExpiry">15 dakika geÃ§erli</small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Aktif Oturumlar -->
    <div class="settings-section">
      <div class="settings-section-header">
        <i class="fas fa-users"></i>
        <h3>Aktif Oturumlar</h3>
      </div>
      <div class="settings-section-body">
        <div id="activeSessions">
          <div class="setting-item">
            <div class="setting-info">
              <div class="setting-title">YÃ¼kleniyor...</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MESAJLAR TAB -->
<div class="tab-content" id="tab-messages">
  <form id="settings-form">
    <div class="settings-grid">
      <!-- Bot MesajlarÄ± -->
      <div class="settings-section">
        <div class="settings-section-header">
          <i class="fas fa-comment-dots"></i>
          <h3>Bot MesajlarÄ±</h3>
        </div>
        <div class="settings-section-body">
          <div class="form-group">
            <label class="form-label">Bot AdÄ±</label>
            <input type="text" name="bot_name" class="form-control" value="<%= settings.bot_name || 'HocanÄ±n YardÄ±mcÄ±sÄ±' %>">
          </div>
          <div class="form-group">
            <label class="form-label">KarÅŸÄ±lama MesajÄ±</label>
            <textarea name="greeting" class="form-control" rows="2"><%= settings.greeting || '{name} kardeÅŸim, hoÅŸ geldin. NasÄ±l yardÄ±mcÄ± olabilirim?' %></textarea>
            <small class="text-muted">{name} kullanÄ±cÄ± adÄ± ile deÄŸiÅŸtirilir</small>
          </div>
          <div class="form-group">
            <label class="form-label">Devir MesajÄ±</label>
            <textarea name="handoff_message" class="form-control" rows="2"><%= settings.handoff_message || 'Ä°nÅŸallah hocamÄ±zla gÃ¶rÃ¼ÅŸtÃ¼rmek iÃ§in not aldÄ±m kardeÅŸim.' %></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Profil TamamlandÄ± MesajÄ±</label>
            <textarea name="profile_complete_message" class="form-control" rows="2"><%= settings.profile_complete_message || '{name} kardeÅŸim, bilgilerini aldÄ±m.' %></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Bot Dondurma MesajÄ±</label>
            <textarea name="frozen_message" class="form-control" rows="2"><%= settings.frozen_message || 'Åu an mÃ¼sait deÄŸilim kardeÅŸim.' %></textarea>
          </div>
        </div>
      </div>

      <!-- AI AyarlarÄ± -->
      <div class="settings-section">
        <div class="settings-section-header">
          <i class="fas fa-brain"></i>
          <h3>AI AyarlarÄ±</h3>
        </div>
        <div class="settings-section-body">
          <div class="form-group">
            <label class="form-label">AI Sistem Promptu</label>
            <textarea name="ai_system_prompt" class="form-control" rows="6"><%= settings.ai_system_prompt || '' %></textarea>
            <small class="text-muted">BoÅŸ bÄ±rakÄ±rsan gÃ¼venli varsayÄ±lan prompt kullanÄ±lÄ±r</small>
          </div>
          <div class="form-group">
            <label class="form-label">Test MesajÄ±</label>
            <div style="display: flex; gap: 1rem;">
              <input type="text" id="testPersonalityInput" class="form-control" placeholder="Bir mesaj yaz...">
              <button type="button" class="btn btn-secondary" id="testPersonalityBtn">Test Et</button>
            </div>
            <pre id="testPersonalityOutput" style="margin-top: 1rem; padding: 1rem; background: var(--bg-darker); border-radius: var(--radius-md); white-space: pre-wrap; display: none;"></pre>
          </div>
        </div>
      </div>
    </div>

    <div style="margin-top: 1.5rem;">
      <button class="btn btn-primary" type="submit">
        <i class="fas fa-save"></i> AyarlarÄ± Kaydet
      </button>
    </div>
  </form>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();

  // Tab switching
  function switchTab(tabName) {
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

    document.querySelector('[onclick="switchTab(\'' + tabName + '\')"]').classList.add('active');
    document.getElementById('tab-' + tabName).classList.add('active');
  }

  // Bot controls
  async function restartBot() {
    if (!confirm('Botu yeniden baÅŸlatmak istiyor musunuz?')) return;
    showToast('Bot yeniden baÅŸlatÄ±lÄ±yor...', 'info');
    try {
      const res = await fetch('/api/system/restart-bot', { method: 'POST' });
      const data = await res.json();
      showToast(data.success ? 'Bot yeniden baÅŸlatÄ±ldÄ±!' : 'Hata: ' + data.error, data.success ? 'success' : 'error');
    } catch (e) {
      showToast('BaÄŸlantÄ± hatasÄ±', 'error');
    }
  }

  async function pauseBot() {
    showToast('Bot duraklatÄ±ldÄ±', 'info');
  }

  async function reconnectWhatsApp() {
    showToast('WhatsApp baÄŸlantÄ±sÄ± yenileniyor...', 'info');
    try {
      const res = await fetch('/api/system/reconnect', { method: 'POST' });
      const data = await res.json();
      showToast(data.success ? 'BaÄŸlantÄ± yenilendi!' : 'Hata: ' + data.error, data.success ? 'success' : 'error');
    } catch (e) {
      showToast('BaÄŸlantÄ± hatasÄ±', 'error');
    }
  }

  function showQRCode() {
    window.open('/qr', '_blank');
  }

  async function clearCache() {
    // KontrollÃ¼ onay kutusu
    const confirmed = await showConfirmDialog(
      'Ã–nbellek Temizleme',
      'Bu iÅŸlem sistem Ã¶nbelleÄŸini temizleyecek. Devam etmek istiyor musunuz?',
      'Temizle',
      'warning'
    );
    if (!confirmed) return;

    showToast('Ã–nbellek temizleniyor...', 'info');
    try {
      const res = await fetch('/api/system/clear-cache', { method: 'POST' });
      const data = await res.json();
      showToast(data.success ? 'Ã–nbellek temizlendi!' : 'Hata: ' + data.error, data.success ? 'success' : 'error');
      loadSystemStats();
    } catch (e) {
      showToast('BaÄŸlantÄ± hatasÄ±', 'error');
    }
  }

  async function exportData() {
    showToast('Veriler hazÄ±rlanÄ±yor...', 'info');
    try {
      const res = await fetch('/api/system/export');
      const data = await res.json();
      if (data.success) {
        const blob = new Blob([JSON.stringify(data.data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'dbot_export_' + new Date().toISOString().split('T')[0] + '.json';
        a.click();
        URL.revokeObjectURL(url);
        showToast('Veriler indirildi!', 'success');
      }
    } catch (e) {
      showToast('DÄ±ÅŸa aktarma hatasÄ±', 'error');
    }
  }

  async function clearAllChats() {
    // Ã‡ok aÅŸamalÄ± kontrollÃ¼ silme
    const confirmed1 = await showConfirmDialog(
      'Sohbetleri Sil',
      '30 gÃ¼nden eski tÃ¼m mesajlarÄ± silmek istiyor musunuz?\n\nBu iÅŸlem GERÄ° ALINAMAZ!',
      'Devam Et',
      'danger'
    );
    if (!confirmed1) return;

    const confirmed2 = await showConfirmDialog(
      'Son Onay',
      'Emin misiniz? Bu iÅŸlem veritabanÄ±ndan eski mesajlarÄ± kalÄ±cÄ± olarak silecek.',
      'Evet, Sil',
      'danger'
    );
    if (!confirmed2) return;

    showToast('Mesajlar siliniyor...', 'info');
    try {
      const res = await fetch('/api/system/clear-chats', { method: 'POST' });
      const data = await res.json();
      showToast(data.success ? data.message : 'Hata: ' + data.error, data.success ? 'success' : 'error');
    } catch (e) {
      showToast('BaÄŸlantÄ± hatasÄ±', 'error');
    }
  }

  // Bot listesini yÃ¼kle
  async function loadBotList() {
    try {
      const res = await fetch('/api/system/bots');
      const data = await res.json();
      if (data.success && data.clients) {
        const clearSelect = document.getElementById('clearBotSelect');
        const destroySelect = document.getElementById('destroyBotSelect');

        // Clear bot select
        if (clearSelect) {
          clearSelect.innerHTML = '<option value="">TÃ¼m Botlar</option>';
          data.clients.forEach(function(bot) {
            clearSelect.innerHTML += '<option value="' + bot.id + '">' + (bot.name || bot.id) + ' (' + (bot.phone || 'BaÄŸlÄ± deÄŸil') + ')</option>';
          });
        }

        // Destroy bot select
        if (destroySelect) {
          destroySelect.innerHTML = '<option value="">Bot SeÃ§in...</option>';
          data.clients.forEach(function(bot) {
            destroySelect.innerHTML += '<option value="' + bot.id + '">' + (bot.name || bot.id) + ' (' + (bot.phone || 'BaÄŸlÄ± deÄŸil') + ')</option>';
          });
        }
      }
    } catch (e) {
      console.error('Bot listesi yÃ¼klenemedi:', e);
    }
  }

  // GeliÅŸmiÅŸ mesaj silme
  async function clearSelectedChats() {
    const clientId = document.getElementById('clearBotSelect').value;
    const timeRange = document.getElementById('deleteTimeRange').value;
    const deleteFromWhatsApp = document.getElementById('deleteFromWhatsApp').checked;

    // Tarih aralÄ±ÄŸÄ± aÃ§Ä±klamalarÄ±
    const timeRangeLabels = {
      '1h': 'son 1 saatteki',
      '24h': 'son 24 saatteki',
      '7d': 'son 1 haftadaki',
      '30d': 'son 1 aydaki',
      '90d': 'son 3 aydaki',
      'all': 'TÃœM'
    };

    let warningText = timeRangeLabels[timeRange] + ' mesajlarÄ±';
    if (clientId) {
      warningText += ' (seÃ§ili bot iÃ§in)';
    } else {
      warningText += ' (tÃ¼m botlar iÃ§in)';
    }
    if (deleteFromWhatsApp) {
      warningText += '\n\nâš ï¸ WhatsApp sohbetleri de temizlenecek!';
    }

    const confirmed1 = await showConfirmDialog(
      'Mesaj Silme',
      warningText + ' silmek istiyor musunuz?\n\nBu iÅŸlem GERÄ° ALINAMAZ!',
      'Devam Et',
      'danger'
    );
    if (!confirmed1) return;

    const confirmed2 = await showConfirmDialog(
      'Son Onay',
      'Emin misiniz? Bu iÅŸlem kalÄ±cÄ±dÄ±r.',
      'Evet, Sil',
      'danger'
    );
    if (!confirmed2) return;

    showToast('Mesajlar siliniyor...', 'info');
    try {
      const res = await fetch('/api/system/clear-chats', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ clientId, timeRange, deleteFromWhatsApp })
      });
      const data = await res.json();
      showToast(data.success ? data.message : 'Hata: ' + data.error, data.success ? 'success' : 'error');
    } catch (e) {
      showToast('BaÄŸlantÄ± hatasÄ±', 'error');
    }
  }

  // Mesaj silme modalÄ±nÄ± gÃ¶ster
  function showClearChatsModal() {
    switchTab('general');
    // Mesaj silme bÃ¶lÃ¼mÃ¼ne scroll
    document.querySelector('#tab-general .settings-section:nth-child(2)').scrollIntoView({ behavior: 'smooth' });
  }

  // Botu imha et
  async function destroyBot() {
    const clientId = document.getElementById('destroyBotSelect').value;
    if (!clientId) {
      showToast('LÃ¼tfen bir bot seÃ§in', 'error');
      return;
    }

    const deleteFromWhatsApp = document.getElementById('destroyDeleteFromWA').checked;
    const logoutWhatsApp = document.getElementById('destroyLogoutWA').checked;

    const confirmed1 = await showConfirmDialog(
      'ğŸ”¥ Bot Ä°mha',
      'Bu bot tamamen silinecek!\n\n' +
      'â€¢ TÃ¼m mesajlar silinecek\n' +
      'â€¢ TÃ¼m profiller silinecek\n' +
      (deleteFromWhatsApp ? 'â€¢ WhatsApp sohbetleri temizlenecek\n' : '') +
      (logoutWhatsApp ? 'â€¢ WhatsApp hesabÄ±ndan Ã§Ä±kÄ±ÅŸ yapÄ±lacak\n' : '') +
      'â€¢ Session dosyalarÄ± silinecek\n\n' +
      'Bu iÅŸlem GERÄ° ALINAMAZ!',
      'Ä°mha Et',
      'danger'
    );
    if (!confirmed1) return;

    const confirmed2 = await showConfirmDialog(
      'âš ï¸ SON UYARI',
      'Bu iÅŸlemi onaylÄ±yor musunuz?\n\nBot: ' + clientId + '\n\nBu iÅŸlem tamamen kalÄ±cÄ±dÄ±r!',
      'EVET, BOTU Ä°MHA ET',
      'danger'
    );
    if (!confirmed2) return;

    showToast('Bot imha ediliyor...', 'info');
    try {
      const res = await fetch('/api/system/destroy-bot/' + clientId, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ deleteFromWhatsApp, logoutWhatsApp })
      });
      const data = await res.json();
      if (data.success) {
        showToast(data.message, 'success');
        loadBotList(); // Listeyi gÃ¼ncelle
        document.getElementById('destroyBotSelect').value = '';
      } else {
        showToast('Hata: ' + data.error, 'error');
      }
    } catch (e) {
      showToast('BaÄŸlantÄ± hatasÄ±', 'error');
    }
  }

  // KontrollÃ¼ onay dialog'u
  function showConfirmDialog(title, message, confirmText, type) {
    return new Promise(function(resolve) {
      const overlay = document.createElement('div');
      overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:10000;display:flex;align-items:center;justify-content:center;';

      const colors = {
        warning: '#f59e0b',
        danger: '#ef4444',
        info: '#3b82f6'
      };

      overlay.innerHTML =
        '<div style="background:var(--bg-card);border-radius:12px;padding:1.5rem;max-width:400px;width:90%;border:1px solid var(--border);">' +
          '<h3 style="margin:0 0 1rem 0;color:' + (colors[type] || colors.info) + ';">' + title + '</h3>' +
          '<p style="margin:0 0 1.5rem 0;color:var(--text-secondary);white-space:pre-line;">' + message + '</p>' +
          '<div style="display:flex;gap:0.75rem;justify-content:flex-end;">' +
            '<button class="btn btn-secondary" id="confirmCancel">Ä°ptal</button>' +
            '<button class="btn" style="background:' + (colors[type] || colors.info) + ';color:white;" id="confirmOk">' + confirmText + '</button>' +
          '</div>' +
        '</div>';

      document.body.appendChild(overlay);

      document.getElementById('confirmCancel').onclick = function() {
        overlay.remove();
        resolve(false);
      };
      document.getElementById('confirmOk').onclick = function() {
        overlay.remove();
        resolve(true);
      };
      overlay.onclick = function(e) {
        if (e.target === overlay) {
          overlay.remove();
          resolve(false);
        }
      };
    });
  }

  // Tema deÄŸiÅŸtirme
  function toggleTheme() {
    const html = document.documentElement;
    const currentTheme = html.getAttribute('data-theme') || 'dark';
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    html.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);

    // Tema buton ikonunu gÃ¼ncelle
    const themeIcon = document.getElementById('themeIcon');
    if (themeIcon) {
      themeIcon.className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
    }

    showToast(newTheme === 'dark' ? 'Koyu tema aktif' : 'AÃ§Ä±k tema aktif', 'success');
  }

  // Sayfa yÃ¼klendiÄŸinde tema uygula
  (function() {
    const savedTheme = localStorage.getItem('theme') || 'dark';
    document.documentElement.setAttribute('data-theme', savedTheme);
  })();

  async function createBackup() {
    showToast('Yedek oluÅŸturuluyor...', 'info');
    try {
      const res = await fetch('/api/system/backup', { method: 'POST' });
      const data = await res.json();
      showToast(data.success ? 'Yedek oluÅŸturuldu!' : 'Hata: ' + data.error, data.success ? 'success' : 'error');
      if (data.success) {
        document.getElementById('lastBackup').textContent = new Date().toLocaleString('tr-TR');
      }
    } catch (e) {
      showToast('BaÄŸlantÄ± hatasÄ±', 'error');
    }
  }

  // Behavior analysis
  async function refreshBehaviorLog() {
    try {
      const res = await fetch('/api/system/behavior-log');
      const data = await res.json();
      if (data.success && data.logs) {
        renderBehaviorLog(data.logs);
        // Ä°statistikleri hesapla
        const total = data.logs.length;
        document.getElementById('totalResponses').textContent = total;
        document.getElementById('avgResponseTime').textContent = '~2s';
        document.getElementById('keywordMatches').textContent = data.keywordMatches || '-';
        document.getElementById('aiResponses').textContent = data.aiResponses || '-';
      } else {
        document.getElementById('behaviorLog').innerHTML = '<div class="behavior-entry"><div class="setting-desc">Veri yÃ¼klenemedi</div></div>';
      }
    } catch (e) {
      console.error(e);
      document.getElementById('behaviorLog').innerHTML = '<div class="behavior-entry"><div class="setting-desc">BaÄŸlantÄ± hatasÄ±</div></div>';
    }
  }

  function renderBehaviorLog(logs) {
    const container = document.getElementById('behaviorLog');
    if (!logs || logs.length === 0) {
      container.innerHTML = '<div class="behavior-entry"><div class="setting-desc">HenÃ¼z aktivite yok</div></div>';
      return;
    }
    container.innerHTML = logs.map(function(log) {
      const time = log.timestamp ? new Date(log.timestamp).toLocaleString('tr-TR') : '-';
      const user = log.userName || 'Bilinmeyen';
      const response = (log.botResponse || '').substring(0, 100) + (log.botResponse?.length > 100 ? '...' : '');
      return '<div class="behavior-entry">' +
        '<div class="behavior-time">' + time + '</div>' +
        '<div class="behavior-action">' + user + ' kullanÄ±cÄ±sÄ±na yanÄ±t</div>' +
        '<div class="behavior-detail">' + response + '</div>' +
      '</div>';
    }).join('');
  }

  async function testBehavior() {
    const message = document.getElementById('testMessage').value;
    if (!message) {
      showToast('LÃ¼tfen test mesajÄ± girin', 'error');
      return;
    }

    const resultDiv = document.getElementById('behaviorTestResult');
    resultDiv.style.display = 'block';
    resultDiv.innerHTML = '<div class="behavior-entry"><div class="setting-desc">Analiz ediliyor...</div></div>';

    try {
      const res = await fetch('/api/system/test-behavior', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: message })
      });
      const data = await res.json();
      if (data.success) {
        const ruleType = data.matchedKeyword ? 'Anahtar Kelime: ' + data.matchedKeyword : (data.usedAI ? 'AI YanÄ±tÄ±' : 'Bilinmiyor');
        resultDiv.innerHTML =
          '<div class="behavior-entry">' +
            '<div class="behavior-action" style="color: var(--primary);">' + ruleType + '</div>' +
            '<div class="behavior-detail" style="margin-top: 0.5rem; padding: 0.75rem; background: rgba(0,217,165,0.1); border-radius: 8px;">' + data.response + '</div>' +
          '</div>';
      } else {
        resultDiv.innerHTML = '<div class="behavior-entry"><div class="setting-desc" style="color: var(--danger);">Hata: ' + data.error + '</div></div>';
      }
    } catch (e) {
      resultDiv.innerHTML = '<div class="behavior-entry"><div class="setting-desc" style="color: var(--danger);">BaÄŸlantÄ± hatasÄ±</div></div>';
    }
  }

  // Notifications
  function togglePushNotifications() {
    const enabled = document.getElementById('pushNotifications').checked;
    if (enabled) {
      if ('Notification' in window) {
        Notification.requestPermission().then(function(permission) {
          if (permission === 'granted') {
            showToast('Push bildirimleri aktif!', 'success');
          } else {
            document.getElementById('pushNotifications').checked = false;
            showToast('Bildirim izni reddedildi', 'error');
          }
        });
      } else {
        document.getElementById('pushNotifications').checked = false;
        showToast('TarayÄ±cÄ±nÄ±z bildirimleri desteklemiyor', 'error');
      }
    }
  }

  function testNotification() {
    if ('Notification' in window && Notification.permission === 'granted') {
      new Notification('Test Bildirimi', {
        body: 'Bu bir test bildirimidir!',
        icon: '/favicon.ico'
      });
    } else {
      showToast('Bildirimleri etkinleÅŸtirin', 'info');
    }
  }

  // Password
  function checkPasswordStrength() {
    const password = document.getElementById('newPassword').value;
    const bar = document.getElementById('passwordStrengthBar');
    const text = document.getElementById('passwordStrengthText');

    let strength = 0;
    if (password.length >= 8) strength += 25;
    if (password.match(/[a-z]/)) strength += 25;
    if (password.match(/[A-Z]/)) strength += 25;
    if (password.match(/[0-9]/)) strength += 25;

    bar.style.width = strength + '%';
    if (strength <= 25) {
      bar.style.background = '#ef4444';
      text.textContent = 'Parola gÃ¼cÃ¼: ZayÄ±f';
    } else if (strength <= 50) {
      bar.style.background = '#f59e0b';
      text.textContent = 'Parola gÃ¼cÃ¼: Orta';
    } else if (strength <= 75) {
      bar.style.background = '#22c55e';
      text.textContent = 'Parola gÃ¼cÃ¼: Ä°yi';
    } else {
      bar.style.background = '#00d9a5';
      text.textContent = 'Parola gÃ¼cÃ¼: GÃ¼Ã§lÃ¼';
    }
  }

  async function changePassword(e) {
    e.preventDefault();
    const current = document.getElementById('currentPassword').value;
    const newPass = document.getElementById('newPassword').value;
    const confirm = document.getElementById('confirmPassword').value;

    if (newPass !== confirm) {
      showToast('Parolalar eÅŸleÅŸmiyor!', 'error');
      return;
    }

    try {
      const res = await fetch('/api/system/change-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ currentPassword: current, newPassword: newPass })
      });
      const data = await res.json();
      showToast(data.success ? 'Parola deÄŸiÅŸtirildi!' : 'Hata: ' + data.error, data.success ? 'success' : 'error');
      if (data.success) {
        document.getElementById('passwordForm').reset();
        document.getElementById('passwordStrengthBar').style.width = '0%';
        document.getElementById('passwordStrengthText').textContent = 'Parola gÃ¼cÃ¼: -';
      }
    } catch (e) {
      showToast('BaÄŸlantÄ± hatasÄ±', 'error');
    }
  }

  function logoutAllDevices() {
    if (confirm('TÃ¼m cihazlardan Ã§Ä±kÄ±ÅŸ yapmak istiyor musunuz?')) {
      showToast('TÃ¼m oturumlar sonlandÄ±rÄ±ldÄ±', 'success');
    }
  }

  function resetSettings() {
    if (confirm('TÃ¼m ayarlarÄ± varsayÄ±lana sÄ±fÄ±rlamak istiyor musunuz?')) {
      showToast('Ayarlar sÄ±fÄ±rlandÄ±', 'success');
    }
  }

  // System stats
  async function loadSystemStats() {
    try {
      const res = await fetch('/api/system/stats');
      const data = await res.json();
      if (data.success && data.stats) {
        document.getElementById('activeBots').textContent = data.stats.activeBots || 0;
        document.getElementById('todayMessages').textContent = data.stats.todayMessages || 0;
        document.getElementById('cacheSize').textContent = data.stats.cacheSize || '0 MB';
        document.getElementById('uptime').textContent = data.stats.uptime || 'Bilinmiyor';
      }
    } catch (e) {
      console.error(e);
    }
  }

  // Security functions
  async function toggle2FA() {
    const enabled = document.getElementById('twoFactor').checked;
    try {
      const res = await fetch('/api/security/2fa', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ enabled })
      });
      const data = await res.json();
      if (data.success) {
        showToast(enabled ? '2FA aktif edildi!' : '2FA devre dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ±', 'success');
      } else {
        document.getElementById('twoFactor').checked = !enabled;
        showToast('Hata: ' + data.error, 'error');
      }
    } catch (e) {
      document.getElementById('twoFactor').checked = !enabled;
      showToast('BaÄŸlantÄ± hatasÄ±', 'error');
    }
  }

  async function toggleIPRestriction() {
    const enabled = document.getElementById('ipRestriction').checked;
    try {
      const res = await fetch('/api/security/ip-restriction', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ enabled })
      });
      const data = await res.json();
      if (data.success) {
        showToast(enabled ? 'IP kÄ±sÄ±tlamasÄ± aktif!' : 'IP kÄ±sÄ±tlamasÄ± devre dÄ±ÅŸÄ±', 'success');
      } else {
        document.getElementById('ipRestriction').checked = !enabled;
        showToast('Hata: ' + data.error, 'error');
      }
    } catch (e) {
      document.getElementById('ipRestriction').checked = !enabled;
      showToast('BaÄŸlantÄ± hatasÄ±', 'error');
    }
  }

  async function toggleMagicLink() {
    const enabled = document.getElementById('magicLinkEnabled').checked;
    await saveSecuritySetting('magic_link_enabled', enabled ? '1' : '0');
  }

  async function saveSecuritySetting(key, value) {
    try {
      const res = await fetch('/api/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ [key]: value })
      });
      const data = await res.json();
      if (data.success) {
        showToast('Ayar kaydedildi', 'success');
      }
    } catch (e) {
      showToast('Kaydetme hatasÄ±', 'error');
    }
  }

  async function generateMagicLink() {
    try {
      const res = await fetch('/api/security/magic-link', { method: 'POST' });
      const data = await res.json();
      if (data.success) {
        document.getElementById('magicLinkResult').style.display = 'block';
        document.getElementById('generatedLink').value = data.link;
        document.getElementById('linkExpiry').textContent = data.expiry + ' dakika geÃ§erli';
        showToast('Magic link oluÅŸturuldu!', 'success');
      } else {
        showToast('Hata: ' + data.error, 'error');
      }
    } catch (e) {
      showToast('BaÄŸlantÄ± hatasÄ±', 'error');
    }
  }

  function copyMagicLink() {
    const link = document.getElementById('generatedLink').value;
    navigator.clipboard.writeText(link).then(function() {
      showToast('Link kopyalandÄ±!', 'success');
    });
  }

  async function loadSecuritySettings() {
    try {
      const res = await fetch('/api/settings');
      const data = await res.json();
      if (data.success && data.settings) {
        const settings = {};
        (Array.isArray(data.settings) ? data.settings : Object.values(data.settings)).forEach(function(s) {
          settings[s.key] = s.value;
        });

        if (settings.two_factor_enabled === '1') {
          document.getElementById('twoFactor').checked = true;
        }
        if (settings.ip_restriction_enabled === '1') {
          document.getElementById('ipRestriction').checked = true;
        }
        if (settings.magic_link_enabled !== '0') {
          document.getElementById('magicLinkEnabled').checked = true;
        }
        if (settings.session_timeout) {
          document.getElementById('sessionTimeout').value = settings.session_timeout;
        }
        if (settings.magic_link_expiry) {
          document.getElementById('magicLinkExpiry').value = settings.magic_link_expiry;
        }
        if (settings.authorized_numbers) {
          document.getElementById('authorizedNumbers').value = settings.authorized_numbers;
        }
      }
    } catch (e) {
      console.error(e);
    }
  }

  async function loadActiveSessions() {
    try {
      const res = await fetch('/api/security/sessions');
      const data = await res.json();
      const container = document.getElementById('activeSessions');
      if (data.success && data.sessions && data.sessions.length > 0) {
        container.innerHTML = data.sessions.map(function(s) {
          return '<div class="setting-item">' +
            '<div class="setting-info">' +
              '<div class="setting-title">' + (s.ip || 'Bilinmeyen IP') + '</div>' +
              '<div class="setting-desc">' + (s.userAgent || 'Bilinmeyen TarayÄ±cÄ±') + ' - ' + new Date(s.createdAt).toLocaleString('tr-TR') + '</div>' +
            '</div>' +
            '<button class="btn btn-danger btn-sm" onclick="revokeSession(\'' + s.id + '\')">' +
              '<i class="fas fa-times"></i>' +
            '</button>' +
          '</div>';
        }).join('');
      } else {
        container.innerHTML = '<div class="setting-item"><div class="setting-info"><div class="setting-desc">Aktif oturum yok</div></div></div>';
      }
    } catch (e) {
      console.error(e);
    }
  }

  async function revokeSession(sessionId) {
    try {
      const res = await fetch('/api/security/sessions/' + sessionId, { method: 'DELETE' });
      const data = await res.json();
      if (data.success) {
        showToast('Oturum sonlandÄ±rÄ±ldÄ±', 'success');
        loadActiveSessions();
      }
    } catch (e) {
      showToast('Hata', 'error');
    }
  }

  // Toast notification
  function showToast(message, type) {
    const existing = document.querySelector('.toast-notification');
    if (existing) existing.remove();

    const toast = document.createElement('div');
    toast.className = 'toast-notification';
    toast.style.cssText = 'position:fixed;top:20px;right:20px;padding:1rem 1.5rem;border-radius:8px;z-index:9999;animation:slideIn 0.3s ease;';

    if (type === 'success') toast.style.background = 'linear-gradient(135deg, #22c55e, #16a34a)';
    else if (type === 'error') toast.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
    else toast.style.background = 'linear-gradient(135deg, #3b82f6, #2563eb)';

    toast.style.color = 'white';
    toast.innerHTML = message;
    document.body.appendChild(toast);

    setTimeout(function() { toast.remove(); }, 3000);
  }

  // AI test button
  document.getElementById('testPersonalityBtn')?.addEventListener('click', async function() {
    const message = document.getElementById('testPersonalityInput')?.value || '';
    const out = document.getElementById('testPersonalityOutput');
    if (out) {
      out.style.display = 'block';
      out.textContent = 'YanÄ±t bekleniyor...';
    }
    try {
      const resp = await fetch('/api/test-personality', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: message })
      });
      const res = await resp.json();
      if (out) out.textContent = res.success ? (res.response || '') : (res.error || 'Hata');
    } catch (e) {
      if (out) out.textContent = e.message;
    }
  });

  // Socket events
  socket.on('newMessage', function(data) {
    if (document.getElementById('notifyNewMessage')?.checked) {
      if ('Notification' in window && Notification.permission === 'granted') {
        new Notification('Yeni Mesaj', { body: data.from + ': ' + data.body.substring(0, 50) });
      }
    }
  });

  // Init
  loadSystemStats();
  refreshBehaviorLog();
  loadSecuritySettings();
  loadActiveSessions();
  loadBotList();
  setInterval(loadSystemStats, 30000);
</script>

<%- include('partials/footer') %>
