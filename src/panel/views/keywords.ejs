<%- include('partials/header', { title, page }) %>

<div class="content-header">
  <h2><i class="fas fa-key"></i> Anahtar Kelimeler</h2>
  <div class="header-actions">
    <button class="btn btn-primary" onclick="openAddModal()">
      <i class="fas fa-plus"></i> Anahtar Kelime Ekle
    </button>
  </div>
</div>

<!-- Bilgi Kartı -->
<div class="card mb-3" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border-left: 4px solid #4ade80;">
  <div class="card-body" style="padding: 1rem;">
    <p style="margin: 0; color: #94a3b8;">
      <i class="fas fa-info-circle" style="color: #4ade80;"></i>
      Belirli anahtar kelimeler geldiğinde otomatik yanıt verilir. AI'dan önce kontrol edilir.
      Yanıtlarda <code>{name}</code> veya <code>{isim}</code> kullanarak kullanıcı adını ekleyebilirsiniz.
    </p>
  </div>
</div>

<div class="card">
  <div class="card-body">
    <% if (keywords && keywords.length > 0) { %>
      <table class="table">
        <thead>
          <tr>
            <th style="width: 25%;">Anahtar Kelime</th>
            <th style="width: 15%;">Eşleşme</th>
            <th style="width: 35%;">Yanıt</th>
            <th style="width: 10%;">Bot</th>
            <th style="width: 5%;">Durum</th>
            <th style="width: 10%;">İşlem</th>
          </tr>
        </thead>
        <tbody>
          <% keywords.forEach(kw => { %>
            <tr data-id="<%= kw.id %>" class="<%= kw.is_active ? '' : 'row-inactive' %>">
              <td>
                <strong><%= kw.keyword %></strong>
                <% if (kw.category) { %>
                  <br><span class="badge badge-secondary"><%= kw.category %></span>
                <% } %>
              </td>
              <td>
                <% if (kw.match_type === 'exact') { %>
                  <span class="badge badge-info">Tam Eşleşme</span>
                <% } else if (kw.match_type === 'contains') { %>
                  <span class="badge badge-primary">İçerir</span>
                <% } else if (kw.match_type === 'startswith') { %>
                  <span class="badge badge-warning">Başlar</span>
                <% } else if (kw.match_type === 'regex') { %>
                  <span class="badge badge-danger">Regex</span>
                <% } %>
              </td>
              <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                <%= kw.response.substring(0, 80) %><%= kw.response.length > 80 ? '...' : '' %>
              </td>
              <td>
                <% if (kw.client_id) { %>
                  <span class="badge badge-secondary"><%= kw.client_id %></span>
                <% } else { %>
                  <span class="badge badge-success">Tümü</span>
                <% } %>
              </td>
              <td>
                <label class="switch">
                  <input type="checkbox" <%= kw.is_active ? 'checked' : '' %> onchange="toggleKeyword(<%= kw.id %>, this.checked)">
                  <span class="slider"></span>
                </label>
              </td>
              <td>
                <button class="btn btn-sm btn-secondary" onclick="editKeyword(<%= kw.id %>)" title="Düzenle">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteKeyword(<%= kw.id %>)" title="Sil">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    <% } else { %>
      <div class="empty-state">
        <i class="fas fa-key"></i>
        <h4>Anahtar Kelime Yok</h4>
        <p>Henüz anahtar kelime eklenmemiş. "Anahtar Kelime Ekle" butonuna tıklayarak ekleyebilirsiniz.</p>
      </div>
    <% } %>
  </div>
</div>

<!-- Add/Edit Modal -->
<div id="keywordModal" class="modal-overlay" style="display: none;">
  <div class="card modal-card">
    <div class="card-header">
      <h3 id="modalTitle"><i class="fas fa-plus"></i> Yeni Anahtar Kelime</h3>
      <button class="btn btn-sm btn-secondary" onclick="closeModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="card-body">
      <form id="keywordForm">
        <input type="hidden" name="id" id="keywordId">

        <div class="form-group">
          <label class="form-label">Anahtar Kelime *</label>
          <input type="text" name="keyword" id="keywordText" class="form-control" required placeholder="namaz vakitleri">
        </div>

        <div class="form-group">
          <label class="form-label">Eşleşme Tipi</label>
          <select name="match_type" id="matchType" class="form-control form-select">
            <option value="contains">İçerir (mesajın içinde geçerse)</option>
            <option value="exact">Tam Eşleşme (birebir aynı)</option>
            <option value="startswith">Başlar (mesaj bununla başlarsa)</option>
            <option value="regex">Regex (ileri seviye)</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Yanıt *</label>
          <textarea name="response" id="responseText" class="form-control" rows="4" required
            placeholder="{name} kardeşim, namaz vakitleri için: https://namazvakti.diyanet.gov.tr"></textarea>
          <small class="form-text text-muted">{name} veya {isim} kullanarak kullanıcının adını ekleyebilirsiniz.</small>
        </div>

        <div class="row">
          <div class="col-6">
            <div class="form-group">
              <label class="form-label">Kategori</label>
              <input type="text" name="category" id="categoryText" class="form-control" placeholder="namaz, dua, bilgi...">
            </div>
          </div>
          <div class="col-6">
            <div class="form-group">
              <label class="form-label">Öncelik</label>
              <input type="number" name="priority" id="priorityNum" class="form-control" value="0" min="0" max="100">
              <small class="form-text text-muted">Yüksek öncelik önce kontrol edilir</small>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Bot</label>
          <select name="client_id" id="clientId" class="form-control form-select">
            <option value="">Tüm Botlar</option>
            <% clients.forEach(c => { %>
              <option value="<%= c.id %>"><%= c.name || c.id %></option>
            <% }) %>
          </select>
          <small class="form-text text-muted">Boş bırakırsanız tüm botlarda çalışır</small>
        </div>

        <button type="submit" class="btn btn-primary w-100">
          <i class="fas fa-save"></i> Kaydet
        </button>
      </form>
    </div>
  </div>
</div>

<style>
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.8);
  z-index: 1000;
  padding: 2rem;
  overflow-y: auto;
}
.modal-card {
  max-width: 600px;
  margin: 2rem auto;
}
.row-inactive {
  opacity: 0.5;
}
.switch {
  position: relative;
  display: inline-block;
  width: 40px;
  height: 22px;
}
.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}
.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #475569;
  transition: .3s;
  border-radius: 22px;
}
.slider:before {
  position: absolute;
  content: "";
  height: 16px;
  width: 16px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  transition: .3s;
  border-radius: 50%;
}
input:checked + .slider {
  background-color: #4ade80;
}
input:checked + .slider:before {
  transform: translateX(18px);
}
.row {
  display: flex;
  gap: 1rem;
}
.col-6 {
  flex: 1;
}
.mb-3 {
  margin-bottom: 1rem;
}
</style>

<script>
// Keyword verilerini sakla
const keywordsData = <%- JSON.stringify(keywords || []) %>;

function openAddModal() {
  document.getElementById('modalTitle').innerHTML = '<i class="fas fa-plus"></i> Yeni Anahtar Kelime';
  document.getElementById('keywordForm').reset();
  document.getElementById('keywordId').value = '';
  document.getElementById('keywordModal').style.display = 'block';
}

function closeModal() {
  document.getElementById('keywordModal').style.display = 'none';
}

function editKeyword(id) {
  const kw = keywordsData.find(k => k.id === id);
  if (!kw) return;

  document.getElementById('modalTitle').innerHTML = '<i class="fas fa-edit"></i> Anahtar Kelime Düzenle';
  document.getElementById('keywordId').value = kw.id;
  document.getElementById('keywordText').value = kw.keyword;
  document.getElementById('matchType').value = kw.match_type || 'contains';
  document.getElementById('responseText').value = kw.response;
  document.getElementById('categoryText').value = kw.category || '';
  document.getElementById('priorityNum').value = kw.priority || 0;
  document.getElementById('clientId').value = kw.client_id || '';

  document.getElementById('keywordModal').style.display = 'block';
}

async function toggleKeyword(id, isActive) {
  try {
    const res = await fetch(`/api/keywords/${id}/toggle`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ is_active: isActive })
    });
    const data = await res.json();
    if (data.success) {
      showToast('Başarılı', isActive ? 'Anahtar kelime aktif edildi' : 'Anahtar kelime pasif edildi', 'success');
    } else {
      showToast('Hata', data.error || 'Bir hata oluştu', 'error');
    }
  } catch (err) {
    showToast('Hata', 'Sunucu hatası', 'error');
  }
}

async function deleteKeyword(id) {
  if (!confirm('Bu anahtar kelimeyi silmek istediğinize emin misiniz?')) return;

  try {
    const res = await fetch(`/api/keywords/${id}`, { method: 'DELETE' });
    const data = await res.json();
    if (data.success) {
      showToast('Başarılı', 'Anahtar kelime silindi', 'success');
      setTimeout(() => location.reload(), 500);
    } else {
      showToast('Hata', data.error || 'Bir hata oluştu', 'error');
    }
  } catch (err) {
    showToast('Hata', 'Sunucu hatası', 'error');
  }
}

document.getElementById('keywordForm')?.addEventListener('submit', async (e) => {
  e.preventDefault();
  const formData = new FormData(e.target);
  const data = {
    keyword: formData.get('keyword'),
    match_type: formData.get('match_type'),
    response: formData.get('response'),
    category: formData.get('category') || null,
    priority: parseInt(formData.get('priority')) || 0,
    client_id: formData.get('client_id') || null
  };

  const id = formData.get('id');
  const url = id ? `/api/keywords/${id}` : '/api/keywords';
  const method = id ? 'PUT' : 'POST';

  try {
    const res = await fetch(url, {
      method,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    const result = await res.json();
    if (result.success) {
      showToast('Başarılı', id ? 'Anahtar kelime güncellendi' : 'Anahtar kelime eklendi', 'success');
      setTimeout(() => location.reload(), 500);
    } else {
      showToast('Hata', result.error || 'Bir hata oluştu', 'error');
    }
  } catch (err) {
    showToast('Hata', 'Sunucu hatası', 'error');
  }
});

// ESC ile modal kapat
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') closeModal();
});
</script>

<%- include('partials/footer') %>
