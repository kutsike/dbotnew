<%- include('partials/header', { title, page }) %>

<div class="content-header">
  <h2>
    <a href="/appointments" class="back-link"><i class="fas fa-arrow-left me-2"></i></a>
    <i class="fas fa-calendar-check"></i> Randevu Detayı
  </h2>
  <div class="header-actions">
    <% if (appointment.status === 'pending') { %>
      <span class="badge badge-warning"><i class="fas fa-clock"></i> Bekliyor</span>
    <% } else if (appointment.status === 'confirmed') { %>
      <span class="badge badge-info"><i class="fas fa-check"></i> Onaylandı</span>
    <% } else if (appointment.status === 'completed') { %>
      <span class="badge badge-success"><i class="fas fa-check-double"></i> Tamamlandı</span>
    <% } else if (appointment.status === 'cancelled') { %>
      <span class="badge badge-danger"><i class="fas fa-times"></i> İptal</span>
    <% } %>
  </div>
</div>

<div class="appointment-detail-grid">
  <!-- Kişi Bilgileri Kartı -->
  <div class="card profile-card">
    <div class="card-header">
      <h3><i class="fas fa-user"></i> Kişi Bilgileri</h3>
    </div>
    <div class="card-body">
      <div class="profile-header">
        <div class="profile-avatar">
          <% if (profile && profile.profile_photo_url) { %>
            <img src="<%= profile.profile_photo_url %>" alt="Profil">
          <% } else { %>
            <i class="fas fa-user"></i>
          <% } %>
        </div>
        <div class="profile-name">
          <h2><%= profile?.full_name || appointment.full_name || 'İsimsiz' %></h2>
          <span class="profile-phone"><%= profile?.phone || appointment.phone || '-' %></span>
        </div>
      </div>

      <div class="info-grid">
        <div class="info-item">
          <label><i class="fas fa-map-marker-alt"></i> Şehir</label>
          <span><%= profile?.city || appointment.city || '-' %></span>
        </div>
        <div class="info-item">
          <label><i class="fas fa-birthday-cake"></i> Doğum Yılı</label>
          <span><%= profile?.birth_date || '-' %></span>
        </div>
        <div class="info-item">
          <label><i class="fas fa-heart"></i> Anne Adı</label>
          <span><%= profile?.mother_name || '-' %></span>
        </div>
        <div class="info-item">
          <label><i class="fas fa-briefcase"></i> Meslek</label>
          <span><%= profile?.job || profile?.occupation || '-' %></span>
        </div>
        <div class="info-item">
          <label><i class="fas fa-ring"></i> Medeni Hal</label>
          <span><%= profile?.marital_status || '-' %></span>
        </div>
        <div class="info-item">
          <label><i class="fas fa-comments"></i> Mesaj Sayısı</label>
          <span><%= profile?.msg_count || 0 %></span>
        </div>
      </div>

      <% if (profile?.notes) { %>
        <div class="notes-section">
          <label><i class="fas fa-sticky-note"></i> Notlar</label>
          <p><%= profile.notes %></p>
        </div>
      <% } %>
    </div>
  </div>

  <!-- Randevu Bilgileri Kartı -->
  <div class="card appointment-card">
    <div class="card-header">
      <h3><i class="fas fa-calendar-alt"></i> Randevu Bilgileri</h3>
    </div>
    <div class="card-body">
      <div class="info-grid">
        <div class="info-item">
          <label><i class="fas fa-hashtag"></i> Randevu ID</label>
          <span>#<%= appointment.id %></span>
        </div>
        <div class="info-item">
          <label><i class="fas fa-calendar"></i> Talep Tarihi</label>
          <span><%= new Date(appointment.requested_at || appointment.created_at).toLocaleDateString('tr-TR', { day: '2-digit', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' }) %></span>
        </div>
        <% if (appointment.scheduled_at) { %>
          <div class="info-item">
            <label><i class="fas fa-clock"></i> Planlanan Tarih</label>
            <span><%= new Date(appointment.scheduled_at).toLocaleDateString('tr-TR', { day: '2-digit', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' }) %></span>
          </div>
        <% } %>
      </div>

      <div class="subject-section">
        <label><i class="fas fa-comment-alt"></i> Konu / Dert</label>
        <div class="subject-content">
          <%= appointment.subject || profile?.subject || 'Konu belirtilmemiş' %>
        </div>
      </div>

      <% if (appointment.notes) { %>
        <div class="notes-section">
          <label><i class="fas fa-clipboard"></i> Randevu Notları</label>
          <p><%= appointment.notes %></p>
        </div>
      <% } %>

      <!-- Durum Değiştirme Butonları -->
      <div class="status-actions">
        <label>Durum Değiştir</label>
        <div class="btn-group">
          <% if (appointment.status !== 'confirmed' && appointment.status !== 'completed') { %>
            <button class="btn btn-info" onclick="updateStatus('confirmed')">
              <i class="fas fa-check"></i> Onayla
            </button>
          <% } %>
          <% if (appointment.status !== 'completed') { %>
            <button class="btn btn-success" onclick="updateStatus('completed')">
              <i class="fas fa-check-double"></i> Tamamla
            </button>
          <% } %>
          <% if (appointment.status !== 'cancelled' && appointment.status !== 'completed') { %>
            <button class="btn btn-danger" onclick="updateStatus('cancelled')">
              <i class="fas fa-times"></i> İptal Et
            </button>
          <% } %>
        </div>
      </div>

      <!-- Not Ekleme -->
      <div class="add-note-section">
        <label><i class="fas fa-plus"></i> Not Ekle</label>
        <textarea id="appointmentNote" class="form-control" rows="3" placeholder="Randevu hakkında not ekleyin..."><%= appointment.notes || '' %></textarea>
        <button class="btn btn-primary mt-2" onclick="saveNote()">
          <i class="fas fa-save"></i> Notu Kaydet
        </button>
      </div>
    </div>
  </div>

  <!-- Son Mesajlar Kartı -->
  <div class="card messages-card">
    <div class="card-header">
      <h3><i class="fas fa-comments"></i> Son Mesajlar</h3>
      <% if (profile?.chat_id) { %>
        <a href="/chats?chat=<%= profile.chat_id %>" class="btn btn-sm btn-primary">
          <i class="fas fa-external-link-alt"></i> Tüm Sohbet
        </a>
      <% } %>
    </div>
    <div class="card-body messages-container">
      <% if (messages && messages.length > 0) { %>
        <div class="messages-list">
          <% messages.forEach(msg => { %>
            <div class="message-item <%= msg.direction === 'incoming' ? 'incoming' : 'outgoing' %>">
              <div class="message-content">
                <%= msg.body || msg.message %>
              </div>
              <div class="message-time">
                <%= new Date(msg.created_at || msg.timestamp).toLocaleString('tr-TR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' }) %>
              </div>
            </div>
          <% }) %>
        </div>
      <% } else { %>
        <div class="empty-state small">
          <i class="fas fa-comment-slash"></i>
          <p>Henüz mesaj yok</p>
        </div>
      <% } %>
    </div>
  </div>

  <!-- AI Analizi Kartı -->
  <% if (profile?.ai_analysis) { %>
    <div class="card analysis-card">
      <div class="card-header">
        <h3><i class="fas fa-brain"></i> AI Analizi</h3>
      </div>
      <div class="card-body">
        <div class="analysis-content">
          <%= profile.ai_analysis %>
        </div>
      </div>
    </div>
  <% } %>

  <!-- Hızlı İşlemler Kartı -->
  <div class="card actions-card">
    <div class="card-header">
      <h3><i class="fas fa-bolt"></i> Hızlı İşlemler</h3>
    </div>
    <div class="card-body">
      <div class="quick-actions">
        <% if (profile?.phone || appointment.phone) { %>
          <a href="tel:<%= profile?.phone || appointment.phone %>" class="action-btn call">
            <i class="fas fa-phone"></i>
            <span>Ara</span>
          </a>
        <% } %>
        <% if (profile?.chat_id) { %>
          <a href="https://wa.me/<%= profile.chat_id.split('@')[0] %>" target="_blank" class="action-btn whatsapp">
            <i class="fab fa-whatsapp"></i>
            <span>WhatsApp</span>
          </a>
        <% } %>
        <button class="action-btn message" onclick="openSendMessage()">
          <i class="fas fa-paper-plane"></i>
          <span>Mesaj Gönder</span>
        </button>
        <button class="action-btn schedule" onclick="openScheduleModal()">
          <i class="fas fa-calendar-plus"></i>
          <span>Randevu Planla</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Mesaj Gönderme Modal -->
<div class="modal" id="sendMessageModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3><i class="fas fa-paper-plane"></i> Mesaj Gönder</h3>
      <button class="close-btn" onclick="closeModal('sendMessageModal')">&times;</button>
    </div>
    <div class="modal-body">
      <textarea id="messageText" class="form-control" rows="4" placeholder="Mesajınızı yazın..."></textarea>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('sendMessageModal')">İptal</button>
      <button class="btn btn-primary" onclick="sendMessage()">
        <i class="fas fa-paper-plane"></i> Gönder
      </button>
    </div>
  </div>
</div>

<style>
.back-link {
  color: var(--text-secondary);
  text-decoration: none;
  transition: color 0.2s;
}
.back-link:hover {
  color: var(--primary);
}

.appointment-detail-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 20px;
}

@media (max-width: 1200px) {
  .appointment-detail-grid {
    grid-template-columns: 1fr;
  }
}

.profile-card .card-body,
.appointment-card .card-body {
  padding: 20px;
}

.profile-header {
  display: flex;
  align-items: center;
  gap: 20px;
  margin-bottom: 25px;
  padding-bottom: 20px;
  border-bottom: 1px solid var(--border);
}

.profile-avatar {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--primary), var(--accent));
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
}

.profile-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.profile-avatar i {
  font-size: 36px;
  color: white;
}

.profile-name h2 {
  margin: 0 0 5px 0;
  font-size: 1.5rem;
  color: var(--text-primary);
}

.profile-phone {
  color: var(--text-secondary);
  font-size: 0.95rem;
}

.info-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 15px;
}

.info-item {
  background: var(--bg-secondary);
  padding: 12px 15px;
  border-radius: 8px;
}

.info-item label {
  display: block;
  font-size: 0.8rem;
  color: var(--text-secondary);
  margin-bottom: 5px;
}

.info-item label i {
  margin-right: 5px;
  color: var(--primary);
}

.info-item span {
  font-size: 1rem;
  color: var(--text-primary);
  font-weight: 500;
}

.subject-section,
.notes-section,
.add-note-section {
  margin-top: 20px;
  padding-top: 15px;
  border-top: 1px solid var(--border);
}

.subject-section label,
.notes-section label,
.add-note-section label {
  display: block;
  font-size: 0.85rem;
  color: var(--text-secondary);
  margin-bottom: 10px;
}

.subject-section label i,
.notes-section label i,
.add-note-section label i {
  margin-right: 5px;
  color: var(--primary);
}

.subject-content {
  background: var(--bg-tertiary);
  padding: 15px;
  border-radius: 8px;
  color: var(--text-primary);
  line-height: 1.6;
  white-space: pre-wrap;
}

.status-actions {
  margin-top: 25px;
  padding-top: 20px;
  border-top: 1px solid var(--border);
}

.status-actions label {
  display: block;
  font-size: 0.85rem;
  color: var(--text-secondary);
  margin-bottom: 10px;
}

.btn-group {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.messages-card {
  grid-column: span 2;
}

@media (max-width: 1200px) {
  .messages-card {
    grid-column: span 1;
  }
}

.messages-container {
  max-height: 400px;
  overflow-y: auto;
}

.messages-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.message-item {
  max-width: 80%;
  padding: 12px 15px;
  border-radius: 12px;
}

.message-item.incoming {
  background: var(--bg-tertiary);
  align-self: flex-start;
  border-bottom-left-radius: 4px;
}

.message-item.outgoing {
  background: var(--primary);
  color: white;
  align-self: flex-end;
  border-bottom-right-radius: 4px;
}

.message-content {
  font-size: 0.95rem;
  line-height: 1.5;
  word-break: break-word;
}

.message-time {
  font-size: 0.75rem;
  opacity: 0.7;
  margin-top: 5px;
  text-align: right;
}

.quick-actions {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 15px;
}

@media (max-width: 768px) {
  .quick-actions {
    grid-template-columns: repeat(2, 1fr);
  }
}

.action-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 20px 15px;
  border-radius: 12px;
  border: none;
  cursor: pointer;
  transition: all 0.2s;
  text-decoration: none;
  color: white;
}

.action-btn i {
  font-size: 24px;
}

.action-btn span {
  font-size: 0.85rem;
}

.action-btn.call {
  background: linear-gradient(135deg, #4CAF50, #45a049);
}

.action-btn.whatsapp {
  background: linear-gradient(135deg, #25D366, #128C7E);
}

.action-btn.message {
  background: linear-gradient(135deg, #2196F3, #1976D2);
}

.action-btn.schedule {
  background: linear-gradient(135deg, #FF9800, #F57C00);
}

.action-btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}

.analysis-card .analysis-content {
  background: var(--bg-tertiary);
  padding: 15px;
  border-radius: 8px;
  white-space: pre-wrap;
  line-height: 1.6;
}

/* Modal */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.7);
  z-index: 1000;
  align-items: center;
  justify-content: center;
}

.modal.active {
  display: flex;
}

.modal-content {
  background: var(--bg-primary);
  border-radius: 12px;
  width: 100%;
  max-width: 500px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.3);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 20px;
  border-bottom: 1px solid var(--border);
}

.modal-header h3 {
  margin: 0;
  font-size: 1.1rem;
}

.close-btn {
  background: none;
  border: none;
  font-size: 24px;
  color: var(--text-secondary);
  cursor: pointer;
}

.modal-body {
  padding: 20px;
}

.modal-footer {
  padding: 15px 20px;
  border-top: 1px solid var(--border);
  display: flex;
  gap: 10px;
  justify-content: flex-end;
}

.empty-state.small {
  padding: 30px;
  text-align: center;
  color: var(--text-secondary);
}

.empty-state.small i {
  font-size: 40px;
  margin-bottom: 10px;
  opacity: 0.5;
}
</style>

<script>
const appointmentId = <%= appointment.id %>;
const chatId = '<%= profile?.chat_id || "" %>';
const clientId = '<%= appointment.client_id || "" %>';

function updateStatus(status) {
  if (!confirm('Durumu değiştirmek istediğinize emin misiniz?')) return;

  fetch(`/api/appointments/${appointmentId}/status`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ status })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      location.reload();
    } else {
      alert('Hata: ' + (data.error || 'Bilinmeyen hata'));
    }
  })
  .catch(err => alert('Hata: ' + err.message));
}

function saveNote() {
  const notes = document.getElementById('appointmentNote').value;

  fetch(`/api/appointments/${appointmentId}/note`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ notes })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      alert('Not kaydedildi');
    } else {
      alert('Hata: ' + (data.error || 'Bilinmeyen hata'));
    }
  })
  .catch(err => alert('Hata: ' + err.message));
}

function openSendMessage() {
  document.getElementById('sendMessageModal').classList.add('active');
}

function closeModal(id) {
  document.getElementById(id).classList.remove('active');
}

function sendMessage() {
  const message = document.getElementById('messageText').value.trim();
  if (!message) {
    alert('Lütfen mesaj yazın');
    return;
  }

  fetch('/api/send-message', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ chatId, clientId, message })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      alert('Mesaj gönderildi');
      closeModal('sendMessageModal');
      document.getElementById('messageText').value = '';
    } else {
      alert('Hata: ' + (data.error || 'Bilinmeyen hata'));
    }
  })
  .catch(err => alert('Hata: ' + err.message));
}

function openScheduleModal() {
  alert('Randevu planlama özelliği yakında eklenecek');
}

// Modal dışına tıklayınca kapat
document.querySelectorAll('.modal').forEach(modal => {
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.classList.remove('active');
    }
  });
});
</script>

<%- include('partials/footer') %>
