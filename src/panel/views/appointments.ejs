<%- include('partials/header', { title, page }) %>

<div class="content-header">
  <h2><i class="fas fa-calendar-check"></i> Randevular</h2>
  <div class="header-actions">
    <a href="/appointments?status=pending" class="btn <%= (status === 'pending') ? 'btn-warning' : 'btn-secondary' %>">
      Bekleyen (<%= appointments.filter(function(a) { return a.status === 'pending'; }).length %>)
    </a>
    <a href="/appointments?status=confirmed" class="btn <%= (status === 'confirmed') ? 'btn-info' : 'btn-secondary' %>">
      Onaylanan
    </a>
    <a href="/appointments?status=all" class="btn <%= (status === 'all' || !status) ? 'btn-primary' : 'btn-secondary' %>">
      Tümü
    </a>
  </div>
</div>

<%
  var list = appointments || [];
  if (status === 'pending') {
    list = list.filter(function(a) { return a.status === 'pending'; });
  } else if (status === 'confirmed') {
    list = list.filter(function(a) { return a.status === 'confirmed'; });
  }
%>

<div class="card">
  <div class="card-body">
    <% if (list && list.length > 0) { %>
      <table class="table">
        <thead>
          <tr>
            <th>İsim</th>
            <th>Telefon</th>
            <th>Şehir</th>
            <th>Konu</th>
            <th>Durum</th>
            <th>Tarih</th>
            <th>İşlemler</th>
          </tr>
        </thead>
        <tbody>
          <% list.forEach(function(apt) { %>
            <tr>
              <td><strong><%= apt.full_name || 'İsimsiz' %></strong></td>
              <td><%= apt.phone ? apt.phone.split('@')[0] : '-' %></td>
              <td><%= apt.city || '-' %></td>
              <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;"><%= apt.subject || '-' %></td>
              <td>
                <% if (apt.status === 'pending') { %>
                  <span class="badge badge-warning">Bekliyor</span>
                <% } else if (apt.status === 'confirmed') { %>
                  <span class="badge badge-info">Onaylandı</span>
                <% } else if (apt.status === 'completed') { %>
                  <span class="badge badge-success">Tamamlandı</span>
                <% } else if (apt.status === 'cancelled') { %>
                  <span class="badge badge-danger">İptal</span>
                <% } else { %>
                  <span class="badge badge-secondary"><%= apt.status %></span>
                <% } %>
              </td>
              <td><%= new Date(apt.requested_at).toLocaleDateString('tr-TR') %></td>
              <td>
                <div class="d-flex gap-2">
                  <a href="/appointments/<%= apt.id %>" class="btn btn-sm btn-primary">
                    <i class="fas fa-eye"></i>
                  </a>
                  <% if (apt.status === 'pending') { %>
                    <button class="btn btn-sm btn-success" onclick="updateAppointmentStatus(<%= apt.id %>, 'confirmed')">
                      <i class="fas fa-check"></i>
                    </button>
                  <% } %>
                  <% if (apt.status === 'confirmed') { %>
                    <button class="btn btn-sm btn-info" onclick="updateAppointmentStatus(<%= apt.id %>, 'completed')">
                      <i class="fas fa-check-double"></i>
                    </button>
                  <% } %>
                  <% if (apt.status !== 'cancelled' && apt.status !== 'completed') { %>
                    <button class="btn btn-sm btn-danger" onclick="updateAppointmentStatus(<%= apt.id %>, 'cancelled')">
                      <i class="fas fa-times"></i>
                    </button>
                  <% } %>
                </div>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    <% } else { %>
      <div class="empty-state">
        <i class="fas fa-calendar"></i>
        <h4>Randevu Yok</h4>
        <p>Bu sekmede henüz randevu bulunmuyor.</p>
      </div>
    <% } %>
  </div>
</div>

<script>
function updateAppointmentStatus(id, newStatus) {
  fetch('/api/appointments/' + id + '/status', {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ status: newStatus })
  })
  .then(function(res) { return res.json(); })
  .then(function(result) {
    if (result.success) {
      showToast('Başarılı', 'Randevu durumu güncellendi', 'success');
      setTimeout(function() { location.reload(); }, 500);
    } else {
      showToast('Hata', result.error || 'Bir hata oluştu', 'error');
    }
  })
  .catch(function(err) {
    showToast('Hata', 'Sunucu hatası', 'error');
  });
}
</script>

<%- include('partials/footer') %>
